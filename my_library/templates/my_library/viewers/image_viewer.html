{% load wagtailimages_tags %}

<style>
    #image-container {
        width: 100%;
        height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
        background: white;
        /* Allow native scrolling on touch devices */
    }
    #image-indicator {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9998;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .image-content {
        display: none;
        width: 100%;
    }
    .image-content.active {
        display: block;
    }
    .image-content img {
        width: 100%;
        height: auto;
        display: block;
    }
</style>

<!-- Contenedor fullscreen para imágenes -->
<div id="image-container">
    {% for image in images %}
    <div class="image-content {% if forloop.first %}active{% endif %}" id="image-content-{{ forloop.counter0 }}">
        {% if image.title %}
        <div class="px-4 py-3 bg-gray-100 text-lg font-bold">{{ image.title }}</div>
        {% endif %}

        {% if image.image %}
            {# Block from ScorePage with .image field #}
            {% image image.image original as img %}
            <img src="{{ img.url }}"
                 alt="{{ image.title|default:'Imagen' }}"
                 data-image-index="{{ forloop.counter0 }}">
        {% elif image.file %}
            {# Wagtail Image object directly - has .file attribute #}
            <img src="{{ image.file.url }}"
                 alt="{{ image.title|default:'Imagen' }}"
                 data-image-index="{{ forloop.counter0 }}">
        {% else %}
            {# Try direct rendering if it's an Image model #}
            {% image image original as img %}
            <img src="{{ img.url }}"
                 alt="{{ image.title|default:'Imagen' }}"
                 data-image-index="{{ forloop.counter0 }}">
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Indicador de imagen (pequeño, abajo centro) -->
{% if images|length > 1 %}
<div id="image-indicator">
    <span id="image-info"></span>
</div>
{% endif %}

<script>
    var currentImage = 0,
        totalImages = {{ images|length }};

    var container = document.getElementById('image-container'),
        imageIndicator = document.getElementById('image-indicator'),
        imageInfo = document.getElementById('image-info');

    var indicatorTimeout = null;
    var isChangingImage = false; // Flag para evitar loops durante cambios programáticos

    // Mostrar indicador de imagen temporalmente
    function showImageIndicator() {
        if (totalImages <= 1) return;
        imageInfo.textContent = `${currentImage + 1} / ${totalImages}`;
        imageIndicator.style.opacity = '1';

        clearTimeout(indicatorTimeout);
        indicatorTimeout = setTimeout(() => {
            imageIndicator.style.opacity = '0';
        }, 1500);
    }

    // Cambiar imagen
    function showImage(index) {
        if (index < 0 || index >= totalImages) return;

        // Marcar que estamos cambiando de imagen programáticamente
        isChangingImage = true;

        // Ocultar todas las imágenes
        document.querySelectorAll('.image-content').forEach(function(el) {
            el.classList.remove('active');
        });

        // Mostrar imagen seleccionada
        currentImage = index;
        document.getElementById('image-content-' + index).classList.add('active');

        // Scroll al inicio
        container.scrollTop = 0;

        showImageIndicator();

        // Desactivar flag después de un momento
        setTimeout(function() {
            isChangingImage = false;
        }, 300);
    }

    // Navegar con solapamiento inteligente (como forScore y PDF viewer)
    function scrollByThird(direction) {
        var viewportHeight = window.innerHeight;
        var currentScroll = container.scrollTop;
        var maxScroll = container.scrollHeight - viewportHeight;

        // Avance del 75% con 25% de solapamiento
        var overlap = viewportHeight * 0.25; // 25% de overlap
        var advance = viewportHeight - overlap; // 75% de avance

        if (direction === 'down') {
            var newScroll = currentScroll + advance;

            // Verificar si ya estamos en el final (tolerancia de 30px para móviles)
            if (currentScroll >= maxScroll - 30) {
                // Ya estamos al final, cambiar a siguiente imagen
                if (currentImage < totalImages - 1) {
                    showImage(currentImage + 1);
                }
                // Si ya estamos en la última imagen, no hacer nada
            } else if (newScroll > maxScroll) {
                // El scroll se pasaría del final, ir al final exacto
                container.scrollTo({
                    top: maxScroll,
                    behavior: 'smooth'
                });
                showImageIndicator();
            } else {
                // Scroll normal con solapamiento
                container.scrollTo({
                    top: newScroll,
                    behavior: 'smooth'
                });
                showImageIndicator();
            }
        } else if (direction === 'up') {
            var newScroll = currentScroll - advance;

            // Verificar si ya estamos en el inicio (tolerancia de 30px para móviles)
            if (currentScroll <= 30) {
                // Ya estamos al inicio, cambiar a imagen anterior
                if (currentImage > 0) {
                    showImage(currentImage - 1);
                    // Ir al final de la imagen anterior
                    setTimeout(() => {
                        var newMaxScroll = container.scrollHeight - viewportHeight;
                        container.scrollTop = newMaxScroll;
                    }, 100);
                }
                // Si ya estamos en la primera imagen, no hacer nada
            } else if (newScroll < 0) {
                // El scroll se pasaría del inicio, ir al inicio exacto
                container.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                showImageIndicator();
            } else {
                // Scroll normal con solapamiento
                container.scrollTo({
                    top: newScroll,
                    behavior: 'smooth'
                });
                showImageIndicator();
            }
        }
    }

    // Click en los lados de la pantalla para navegar
    container.addEventListener('click', function(e) {
        var clickX = e.clientX;
        var screenWidth = window.innerWidth;

        if (clickX > screenWidth * 0.7) {
            // Click en lado derecho - avanzar
            scrollByThird('down');
        } else if (clickX < screenWidth * 0.3) {
            // Click en lado izquierdo - retroceder
            scrollByThird('up');
        } else if (window.toggleViewerTopbar) {
            // Centro: dejar que el viewer haga toggle de la barra
            window.toggleViewerTopbar();
        }
    });
    
    // Detectar cuando llegamos al final del scroll para cambiar de imagen automáticamente
    var scrollTimeout;
    container.addEventListener('scroll', function() {
        // Ignorar eventos de scroll durante cambios programáticos de imagen
        if (isChangingImage) return;

        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(function() {
            // Verificar de nuevo porque podría haber cambiado
            if (isChangingImage) return;

            var viewportHeight = window.innerHeight;
            var currentScroll = container.scrollTop;
            var maxScroll = container.scrollHeight - viewportHeight;
            
            // Si llegamos al final, avanzar automáticamente a la siguiente imagen
            if (currentScroll >= maxScroll - 5 && currentImage < totalImages - 1) {
                showImage(currentImage + 1);
            }
        }, 150); // Esperar que el usuario termine de hacer scroll
    });

    // Click en los lados de la pantalla para navegar (recuperado)
    container.addEventListener('click', function(e) {
        var clickX = e.clientX;
        var screenWidth = window.innerWidth;

        if (clickX > screenWidth * 0.7) {
            // Click en lado derecho - avanzar
            scrollByThird('down');
        } else if (clickX < screenWidth * 0.3) {
            // Click en lado izquierdo - retroceder
            scrollByThird('up');
        } else if (window.toggleViewerTopbar) {
            // Centro: toggle de la barra
            window.toggleViewerTopbar();
        }
    });

    // Touch events para dispositivos móviles (más confiables que click)
    var touchStartX = 0;
    var touchStartY = 0;
    var touchStartTime = 0;
    
    container.addEventListener('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
    }, { passive: true });
    
    container.addEventListener('touchend', function(e) {
        var touchEndX = e.changedTouches[0].clientX;
        var touchEndY = e.changedTouches[0].clientY;
        var touchDuration = Date.now() - touchStartTime;
        
        // Solo procesar si es un tap rápido (no un scroll)
        if (touchDuration < 300) {
            var deltaX = Math.abs(touchEndX - touchStartX);
            var deltaY = Math.abs(touchEndY - touchStartY);
            
            // Si el movimiento fue pequeño, es un tap
            if (deltaX < 10 && deltaY < 10) {
                var screenWidth = window.innerWidth;
                
                if (touchEndX > screenWidth * 0.7) {
                    // Tap en lado derecho - avanzar
                    e.preventDefault();
                    scrollByThird('down');
                } else if (touchEndX < screenWidth * 0.3) {
                    // Tap en lado izquierdo - retroceder
                    e.preventDefault();
                    scrollByThird('up');
                } else if (window.toggleViewerTopbar) {
                    // Centro: toggle de la barra
                    window.toggleViewerTopbar();
                }
            }
        }
    });

    // Navegación con teclado
    document.addEventListener('keydown', function (e) {
        switch (e.key) {
            case 'Escape':
                // Dejar que se maneje en viewer.html
                break;
            case 'ArrowRight':
            case 'ArrowDown':
            case 'PageDown':
            case ' ': // Espacio
                e.preventDefault();
                scrollByThird('down');
                break;
            case 'ArrowLeft':
            case 'ArrowUp':
            case 'PageUp':
                e.preventDefault();
                scrollByThird('up');
                break;
        }
    });

    // Mostrar indicador inicial si hay múltiples imágenes
    if (totalImages > 1) {
        showImageIndicator();
    }
</script>
