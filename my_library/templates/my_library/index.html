{% extends "base.html" %}

{% block title %}Mi Biblioteca Personal{% endblock %}

{% block extra_css %}
<style>
    /* Mejoras visuales para filas de lista */
    .list-row:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* Responsive para m√≥viles */
    @media (max-width: 768px) {
        .list-row {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.75rem;
        }
        
        .list-row > div:last-child {
            width: 100%;
        }
        
        .list-row .btn {
            width: 100%;
        }
    }

    /* Estilos para el slider de progreso musical */
    .proficiency-range::-webkit-slider-runnable-track {
        background-size: var(--range-shading, 0%) 100%;
        background-repeat: no-repeat;
    }
    
    .range-error.proficiency-range { --range-color: var(--fallback-er,oklch(var(--er))); }
    .range-warning.proficiency-range { --range-color: var(--fallback-wa,oklch(var(--wa))); }
    .range-success.proficiency-range { --range-color: var(--fallback-su,oklch(var(--su))); }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold">üìö Mi Biblioteca Personal</h1>
        <a href="/pages/indice-de-recursos-musicales/" class="btn btn-ghost btn-sm sm:btn-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Volver a √çndice de Recursos Musicales
        </a>
    </div>
    
    <div class="stats shadow mb-6">
        <div class="stat">
            <div class="stat-figure text-primary">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div class="stat-title">Elementos guardados</div>
            <div class="stat-value text-primary">{{ total_items }}</div>
            <div class="stat-desc">En tu biblioteca personal</div>
        </div>
    </div>
    
    {% if items %}
    {% include "partials/library_filter_controls.html" %}

    <!-- Lista (una fila por elemento) -->
    <ul class="list bg-base-100 rounded-box shadow-md" id="libraryItemsList">
        <li class="p-4 pb-2 text-xs opacity-60 tracking-wide">
            Tu colecci√≥n ¬∑ Ordenado: de menos a m√°s estrellas ‚≠ê, luego de menos a m√°s vistas üëÅÔ∏è
        </li>
        
        {% for item in items %}
        {% with related_score=item.get_related_scorepage %}
        <li class="list-row library-item js-library-filter-item" id="library-item-{{ item.pk }}"
            data-title="{{ item.get_content_title|lower }}"
            data-type="{{ item.get_content_type_name|lower }}"
            data-related-score="{% if related_score %}{{ related_score.title|lower }}{% endif %}"
            data-composer="{% if related_score and related_score.composer %}{{ related_score.composer.name|lower }}{% endif %}"
            data-categories="{% if related_score and related_score.categories.all %}{% for category in related_score.categories.all %}{{ category.name|lower }} {% endfor %}{% endif %}"
            data-tags="{% if item.content_object and item.content_object.tags.all %}{% for tag in item.content_object.tags.all %}{{ tag.name|lower }} {% endfor %}{% endif %}{% if related_score and related_score.tags.all %}{% for tag in related_score.tags.all %}{{ tag.name|lower }} {% endfor %}{% endif %}"
            data-pdfs="{% if related_score %}{% for pdf in related_score.get_pdf_blocks %}{{ pdf.title|lower }} {% endfor %}{% endif %}"
            data-audios="{% if related_score %}{% for audio in related_score.get_audios %}{{ audio.title|lower }} {% endfor %}{% endif %}"
            data-document-tags="{% if related_score %}{% for pdf in related_score.get_pdf_blocks %}{% for doc_tag in pdf.pdf_file.tags.all %}{{ doc_tag.name|lower }} {% endfor %}{% endfor %}{% for audio in related_score.get_audios %}{% for doc_tag in audio.audio_file.tags.all %}{{ doc_tag.name|lower }} {% endfor %}{% endfor %}{% endif %}">
            <!-- Icon -->
            <div class="flex items-center justify-center size-12 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-lg flex-shrink-0">
                <div class="text-2xl">{{ item.get_icon }}</div>
            </div>
            
            <!-- Info -->
            <div class="flex-1 min-w-0">
                <div class="font-semibold text-base">{{ item.get_content_title }}</div>
                <div class="text-xs opacity-60">{{ item.get_content_type_name }}</div>
                
                <!-- Enlace a ScorePage relacionada (SIEMPRE visible) -->
                {% if related_score %}
                <div class="mt-1">
                    <a href="{{ related_score.get_url }}" 
                       class="inline-flex items-center gap-1 text-xs {% if item.content_type.model == 'scorepage' %}link link-success{% else %}link link-primary{% endif %} link-hover">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        {% if item.content_type.model == 'scorepage' %}
                        Ver en Biblioteca
                        {% else %}
                        De: {{ related_score.title }}
                        {% endif %}
                    </a>
                </div>
                {% endif %}
                
                <!-- Meta info -->
                <div class="text-xs opacity-40 mt-1 flex items-center gap-3">
                    <span>A√±adido: {{ item.added_at|date:"d/m/Y" }}</span>
                    {% if item.times_viewed > 0 %}
                    <span>¬∑ Visto {{ item.times_viewed }} ve{% if item.times_viewed > 1 %}ces{% else %}z{% endif %}</span>
                    {% endif %}
                </div>
                
                <!-- Nivel de conocimiento -->
                <div class="mt-2">
                    {% include "my_library/partials/proficiency_slider.html" with item=item %}
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex gap-2 items-center">
                {% if item.content_type.model == 'scorepage' %}
                <a href="{{ item.content_object.get_url }}" class="btn btn-sm btn-primary">
                    Ver Partitura
                </a>
                {% else %}
                <a href="{{ item.get_viewer_url }}" class="btn btn-sm btn-primary">
                    Abrir Visor
                </a>
                {% endif %}
                
                <button hx-delete="{% url 'my_library:remove' item.pk %}"
                        hx-target="#library-item-{{ item.pk }}"
                        hx-swap="outerHTML"
                        hx-confirm="¬øQuitar de tu biblioteca?"
                        class="btn btn-sm btn-ghost btn-square"
                        title="Quitar de biblioteca">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </li>
        {% endwith %}
        {% endfor %}
    </ul>

    {% include "partials/library_filter_script.html" %}
    
    <script>
        /**
         * Reordenar la lista din√°micamente seg√∫n los criterios de la biblioteca
         */
        function reorderLibraryList() {
            const list = document.getElementById('libraryItemsList');
            const items = Array.from(list.querySelectorAll('.library-item'));
            
            items.sort((a, b) => {
                // 1. Proficiency (Ascendente: 0 -> 4)
                const profA = parseInt(a.dataset.proficiency);
                const profB = parseInt(b.dataset.proficiency);
                if (profA !== profB) return profA - profB;
                
                // 2. Vistas (Ascendente)
                const viewsA = parseInt(a.dataset.views);
                const viewsB = parseInt(b.dataset.views);
                if (viewsA !== viewsB) return viewsA - viewsB;
                
                // 3. Fecha a√±adido (Descendente: m√°s reciente primero)
                const addedA = new Date(a.dataset.added);
                const addedB = new Date(b.dataset.added);
                return addedB - addedA;
            });
            
            // Reinsertar elementos en el nuevo orden con una peque√±a animaci√≥n
            items.forEach((item, index) => {
                list.appendChild(item);
            });
        }

        // Escuchar el evento de HTMX despu√©s de que se actualiza el slider
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id.startsWith('proficiency-')) {
                const itemId = evt.detail.target.id.replace('proficiency-', '');
                const li = document.getElementById('library-item-' + itemId);
                const newVal = evt.detail.target.querySelector('input').value;
                
                // Actualizar el dataset para el ordenamiento
                li.dataset.proficiency = newVal;
                
                // Reordenar
                reorderLibraryList();
            }
        });

        /**
         * Actualiza el color del slider de forma din√°mica mientras se arrastra
         */
        function updateRangeColor(input) {
            const val = parseInt(input.value);
            
            // Eliminar clases de color previas
            input.classList.remove('range-error', 'range-warning', 'range-success');
            
            // A√±adir nueva clase seg√∫n el valor
            if (val === 0) {
                input.classList.add('range-error');
            } else if (val <= 2) {
                input.classList.add('range-warning');
            } else {
                input.classList.add('range-success');
            }
        }
    </script>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-12 bg-base-100 rounded-box shadow">
        <div class="text-6xl mb-4">üìö</div>
        <h2 class="text-2xl font-bold mb-2">Tu biblioteca est√° vac√≠a</h2>
        <p class="text-base-content/70 mb-6">
            Explora la biblioteca musical y a√±ade contenido que quieras revisar m√°s tarde.
        </p>
        <a href="/pages/indice-de-recursos-musicales/" class="btn btn-primary">
            Explorar Biblioteca Musical
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
