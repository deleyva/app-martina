{% extends "incidencias/base_incidencias.html" %}
{% load static i18n %}

{% block incidencias_content %}
<div class="max-w-7xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
    <div>
      <h1 class="text-3xl font-bold">ğŸ› ï¸ Panel de Incidencias</h1>
      <p class="opacity-60">GestiÃ³n y seguimiento de incidencias informÃ¡ticas</p>
    </div>
    <div class="flex gap-2">
      <a href="{% url 'incidencias:panel_tecnicos' %}" class="btn btn-outline btn-sm gap-1">
        ğŸ‘· Gestionar tÃ©cnicos
      </a>
      <a href="{% url 'incidencias:landing' %}" class="btn btn-ghost btn-sm gap-1">
        ğŸ”§ Vista pÃºblica
      </a>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-base-200 rounded-xl p-4 mb-6">
    <form method="get" class="flex flex-wrap gap-3 items-end"
          hx-get="." 
          hx-trigger="input delay:500ms, change, submit" 
          hx-target="#dashboard-container" 
          hx-select="#dashboard-container" 
          hx-swap="outerHTML"
          hx-push-url="true">
      <div class="form-control">
        <label class="label label-text text-xs">UbicaciÃ³n</label>
        <input type="text" name="ubicacion" 
               class="input input-bordered input-sm w-40" 
               placeholder="Aula, grupo, PB (planta baja), P1 o P2..." 
               value="{{ filtro_ubicacion }}">
      </div>
      <div class="form-control">
        <label class="label label-text text-xs">Urgencia</label>
        <select name="urgencia" class="select select-bordered select-sm">
          <option value="">Todas</option>
          {% for value, label in urgencias %}
            <option value="{{ value }}" {% if filtro_urgencia == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-control">
        <label class="label label-text text-xs">Etiqueta</label>
        <input type="text" name="etiqueta" 
               class="input input-bordered input-sm w-32" 
               placeholder="Etiqueta..." 
               value="{{ filtro_etiqueta }}">
      </div>
      <div class="form-control">
        <label class="label label-text text-xs">TÃ©cnico</label>
        <select name="tecnico" class="select select-bordered select-sm">
          <option value="">Todos</option>
          <option value="sin_asignar" {% if filtro_tecnico == "sin_asignar" %}selected{% endif %}>Sin asignar</option>
          {% for t in tecnicos %}
            <option value="{{ t.id }}" {% if filtro_tecnico == t.id|stringformat:"d" %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <a href="{% url 'incidencias:panel' %}" class="btn btn-ghost btn-sm">Limpiar</a>
    </form>
  </div>

  <div id="dashboard-container">
    <!-- Mis incidencias -->
    {% if mis_incidencias %}
    <div class="bg-primary/10 border border-primary/30 rounded-xl p-4 mb-6">
      <div class="flex items-center gap-2 mb-3">
        <h2 class="text-lg font-bold">ğŸ™‹ Mis incidencias asignadas</h2>
        <span class="badge badge-primary">{{ mis_incidencias|length }}</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        {% for inc in mis_incidencias %}
          {% include "incidencias/partials/panel_card.html" with incidencia=inc %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Kanban Board -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Pendientes -->
      <div>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-bold">â³ Pendientes</h2>
          <span class="badge badge-warning" id="badge-pendiente">{{ pendientes|length }}</span>
        </div>
        <div class="space-y-3 kanban-column min-h-[100px] rounded-xl p-2 transition-colors duration-200" data-status="pendiente">
          {% for inc in pendientes %}
            {% include "incidencias/partials/panel_card.html" with incidencia=inc %}
          {% empty %}
            <div class="text-center py-8 opacity-40 text-sm kanban-empty">Sin incidencias pendientes</div>
          {% endfor %}
        </div>
      </div>

      <!-- En Progreso -->
      <div>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-bold">âš¡ En Progreso</h2>
          <span class="badge badge-info" id="badge-en_progreso">{{ en_progreso|length }}</span>
        </div>
        <div class="space-y-3 kanban-column min-h-[100px] rounded-xl p-2 transition-colors duration-200" data-status="en_progreso">
          {% for inc in en_progreso %}
            {% include "incidencias/partials/panel_card.html" with incidencia=inc %}
          {% empty %}
            <div class="text-center py-8 opacity-40 text-sm kanban-empty">Sin incidencias en progreso</div>
          {% endfor %}
        </div>
      </div>

      <!-- Resueltas -->
      <div>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-bold">âœ… Resueltas</h2>
          <span class="badge badge-success" id="badge-resuelta">{{ resueltas|length }}</span>
        </div>
        <div class="space-y-3 kanban-column min-h-[100px] rounded-xl p-2 transition-colors duration-200" data-status="resuelta">
          {% for inc in resueltas %}
            {% include "incidencias/partials/panel_card.html" with incidencia=inc %}
          {% empty %}
            <div class="text-center py-8 opacity-40 text-sm kanban-empty">Sin incidencias resueltas</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drag-and-Drop JavaScript -->
<style>
  .kanban-column.drag-over {
    background-color: oklch(var(--p) / 0.1);
    border: 2px dashed oklch(var(--p) / 0.4);
  }
  .incidencia-card[draggable="true"] {
    cursor: grab;
  }
  .incidencia-card[draggable="true"]:active {
    cursor: grabbing;
  }
  .incidencia-card.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
  }
</style>

<script>
function initKanban() {
  const columns = document.querySelectorAll('.kanban-column');
  const cards = document.querySelectorAll('.incidencia-card[draggable="true"]');

  // Assign descending z-index so upper cards stack above lower ones
  function assignCardZIndex() {
    columns.forEach(column => {
      const columnCards = column.querySelectorAll('.incidencia-card');
      columnCards.forEach((card, index) => {
        card.style.position = 'relative';
        card.style.zIndex = 100 - index;
      });
    });
  }

  // Apply on initial load
  assignCardZIndex();

  // Get CSRF token from cookie
  function getCsrfToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        return cookie.substring(name.length + 1);
      }
    }
    // Fallback: try to get from the meta tag or hidden input
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfInput ? csrfInput.value : '';
  }

  // Card drag events
  cards.forEach(card => {
    card.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text/plain', this.dataset.incidenciaId);
      e.dataTransfer.effectAllowed = 'move';
      this.classList.add('dragging');
    });

    card.addEventListener('dragend', function(e) {
      this.classList.remove('dragging');
      // Remove all drag-over highlights
      columns.forEach(col => col.classList.remove('drag-over'));
    });
  });

  // Column drop zone events
  columns.forEach(column => {
    // Remove existing event listeners to prevent duplicates if re-initialized
    // (Note: cloning node is a common trick, but here we are in a scoped init function
    //  that runs on fresh DOM elements after HTMX swap, or on load. 
    //  Since HTMX swap replaces elements, we don't need to worry about removing listeners 
    //  from the *old* elements, but we should be careful not to attach double listeners 
    //  if we call initKanban() on the whole document repeatedly without replacement.
    //  However, with hx-target="#dashboard-container", the script tag generally remains outside.
    //  So we are safe.)

    column.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      this.classList.add('drag-over');
    });

    column.addEventListener('dragleave', function(e) {
      // Only remove if leaving the column entirely
      if (!this.contains(e.relatedTarget)) {
        this.classList.remove('drag-over');
      }
    });

    column.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('drag-over');

      const incidenciaId = e.dataTransfer.getData('text/plain');
      const newStatus = this.dataset.status;
      const card = document.querySelector(`.incidencia-card[data-incidencia-id="${incidenciaId}"]`);

      if (!card || !incidenciaId || !newStatus) return;

      // Find the source column
      const sourceColumn = card.closest('.kanban-column');
      if (sourceColumn === this) return; // Dropped in same column

      // Optimistic UI: move the card immediately
      const emptyMsg = this.querySelector('.kanban-empty');
      if (emptyMsg) emptyMsg.remove();
      this.appendChild(card);

      // Show empty message in source if needed
      if (sourceColumn && sourceColumn.querySelectorAll('.incidencia-card').length === 0) {
        const statusLabels = {
          'pendiente': 'Sin incidencias pendientes',
          'en_progreso': 'Sin incidencias en progreso',
          'resuelta': 'Sin incidencias resueltas'
        };
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'text-center py-8 opacity-40 text-sm kanban-empty';
        emptyDiv.textContent = statusLabels[sourceColumn.dataset.status] || 'Sin incidencias';
        sourceColumn.appendChild(emptyDiv);
      }

      // Update badge counters and z-indices
      updateBadges();
      assignCardZIndex();

      // Send API request
      fetch(`/incidencias/panel/api/estado/${incidenciaId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ estado: newStatus }),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Error al cambiar estado');
        }
        return response.json();
      })
      .then(data => {
        if (!data.ok) {
          // Revert: move card back
          if (sourceColumn) sourceColumn.appendChild(card);
          updateBadges();
          assignCardZIndex();
          alert('Error: ' + (data.error || 'No se pudo cambiar el estado'));
        }
      })
      .catch(err => {
        // Revert on network error
        if (sourceColumn) sourceColumn.appendChild(card);
        updateBadges();
        assignCardZIndex();
        console.error('Error:', err);
      });
    });
  });

  function updateBadges() {
    columns.forEach(column => {
      const status = column.dataset.status;
      const badge = document.getElementById(`badge-${status}`);
      if (badge) {
        const count = column.querySelectorAll('.incidencia-card').length;
        badge.textContent = count;
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', initKanban);
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'dashboard-container') {
        initKanban();
    }
});
</script>
{% endblock incidencias_content %}
