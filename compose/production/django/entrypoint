#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

if [ -z "${POSTGRES_USER}" ]; then
    base_postgres_image_default_user='postgres'
    export POSTGRES_USER="${base_postgres_image_default_user}"
fi
export DATABASE_URL="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"

wait-for-it "${POSTGRES_HOST}:${POSTGRES_PORT}" -t 30

>&2 echo 'PostgreSQL is available'

# Archivo CSS fuente de Tailwind que causa conflicto con Whitenoise
SOURCE_CSS_FILE="/app/martina_bescos_app/static/css/index.css"
# Archivo CSS compilado por Tailwind
COMPILED_CSS_FILE="/app/martina_bescos_app/static/css/output.css"

# Verificar si el archivo fuente existe antes de intentar borrarlo
if [ -f "$SOURCE_CSS_FILE" ]; then
  echo "Temporarily removing source CSS file: $SOURCE_CSS_FILE"
  # Eliminar el archivo fuente para evitar que Whitenoise lo procese
  rm "$SOURCE_CSS_FILE"
else
  echo "Source CSS file not found, skipping removal: $SOURCE_CSS_FILE"
fi

# Verificar si el archivo compilado existe (¡debería!)
if [ ! -f "$COMPILED_CSS_FILE" ]; then
  echo "ERROR: Compiled CSS file not found: $COMPILED_CSS_FILE"
  echo "Check the 'npm run build' step in the Dockerfile build process."
  exit 1
fi

>&2 echo "Running collectstatic..."
# Ejecuta collectstatic usando el usuario 'django' (definido en Dockerfile)
# Necesita permisos de escritura en STATIC_ROOT (/app/staticfiles por defecto)
python /app/manage.py collectstatic --noinput


exec "$@"
