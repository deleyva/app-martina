{% extends "base.html" %}

{% load static %}

{% block title %}Music Items{% endblock %}

{% block content %}
<!-- ABCJS for music notation -->
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/dist/abcjs-basic-min.min.js" onload="console.log('ABCJS script loaded')"></script>
<script>
/* Music Cards specific JavaScript */

// Función para inicializar ABCJS cuando esté disponible
function initializeABCJS() {
  console.log('Attempting to initialize ABCJS...');
  
  if (typeof ABCJS !== 'undefined') {
    console.log('ABCJS loaded successfully, version:', ABCJS.signature);
    
    // Buscar contenedores ABC
    const containers = document.querySelectorAll('.abc-notation-container');
    console.log('Found', containers.length, 'ABC containers');
    
    // Renderizar todas las notaciones ABC existentes en la página
    containers.forEach(function(container, index) {
      const abcContent = container.getAttribute('data-abc-content');
      console.log('Container', index + 1, '- ID:', container.id, '- Content length:', abcContent ? abcContent.length : 0);
      
      if (abcContent && abcContent.trim() !== '') {
        try {
          console.log('Rendering ABC for container:', container.id);
          console.log('ABC Content full:', abcContent);
          console.log('ABC Content preview:', abcContent.substring(0, 100) + '...');
          
          // Limpiar el contenedor antes de renderizar
          container.innerHTML = '';
          
          const result = ABCJS.renderAbc(container.id, abcContent, {
            viewportHorizontal: true,
            scrollHorizontal: true,
            responsive: "resize",
            scale: 0.8,
            staffwidth: 400
          });
          
          console.log('Render result:', result);
          
          // Verificar si se creó contenido SVG
          setTimeout(() => {
            const svgElements = container.querySelectorAll('svg');
            console.log('SVG elements created:', svgElements.length);
            if (svgElements.length === 0) {
              console.error('No SVG created for container:', container.id);
              container.innerHTML = '<p style="color: red;">Error: No se pudo renderizar la partitura</p>';
            }
          }, 100);
          
        } catch (error) {
          console.error('Error rendering ABC notation for', container.id, ':', error);
          container.innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
        }
      } else {
        console.warn('No ABC content found for container:', container.id);
        container.innerHTML = '<p style="color: orange;">No hay contenido ABC</p>';
      }
    });
  } else {
    console.error('ABCJS not loaded, retrying in 500ms...');
    // Intentar de nuevo en 500ms
    setTimeout(initializeABCJS, 500);
  }
}

// Función de test para probar ABCJS manualmente
function testABCJS() {
  console.log('Testing ABCJS...');
  
  if (typeof ABCJS === 'undefined') {
    console.error('ABCJS not loaded yet. Waiting...');
    waitForABCJS(testABCJS);
    return;
  }
  
  // Crear un contenedor de prueba
  const testContainer = document.createElement('div');
  testContainer.id = 'test-abc-container';
  testContainer.style.border = '2px solid red';
  testContainer.style.padding = '10px';
  testContainer.style.margin = '10px';
  document.body.appendChild(testContainer);
  
  // Notación ABC simple de prueba
  const testABC = `X:1
T:Test Song
M:4/4
L:1/4
K:C
C D E F | G A B c |`;
  
  console.log('Test ABC content:', testABC);
  
  try {
    const result = ABCJS.renderAbc('test-abc-container', testABC, {
      scale: 1.0,
      staffwidth: 400
    });
    console.log('Test render result:', result);
  } catch (error) {
    console.error('Test render error:', error);
  }
}

// Función para esperar a que ABCJS se cargue
function waitForABCJS(callback, maxAttempts = 50) {
  let attempts = 0;
  
  function check() {
    attempts++;
    console.log(`Checking for ABCJS... attempt ${attempts}`);
    
    if (typeof ABCJS !== 'undefined') {
      console.log('ABCJS found!');
      callback();
    } else if (attempts < maxAttempts) {
      setTimeout(check, 200); // Esperar 200ms entre intentos
    } else {
      console.error('ABCJS failed to load after', maxAttempts, 'attempts');
    }
  }
  
  check();
}

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, waiting for ABCJS...');
  waitForABCJS(initializeABCJS);
});

// Exportar funciones para uso global
window.testABCJS = testABCJS;
window.initializeABCJS = initializeABCJS;
</script>

<div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-base-content">Music Items</h2>
        <div class="badge badge-primary badge-lg">{{ music_items|length }} items</div>
    </div>
    <div class="space-y-6">
        {% for music_item in music_items %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex items-start gap-4">
                    <div class="flex-1">
                        <h3 class="card-title text-2xl mb-2">{{ music_item.title }}</h3>
                        <div class="flex gap-2 mb-4">
                            <a href="{% url 'music_cards:music_item_detail' music_item.id %}" class="btn btn-sm btn-outline btn-info">
                                <i class="fas fa-info-circle mr-1"></i>
                                Detalles
                            </a>
                            {% if user.is_staff or user.is_superuser %}
                                <a href="{% url 'admin:music_cards_musicitem_change' music_item.id %}" class="btn btn-sm btn-outline btn-warning">
                                    <i class="fas fa-edit mr-1"></i>
                                    Editar
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex-[2]">
                        {% if music_item.text %}
                            <div class="bg-base-200 rounded-lg p-4">
                                <div id="abc-container{{ forloop.counter }}" 
                                     data-abc-content="{{ music_item.text.content|safe }}"
                                     class="abc-notation-container"></div>
                            </div>
                        {% elif music_item.mxml_file %}
                            <div class="bg-base-200 rounded-lg p-4">
                                <div id="osmdContainer{{ forloop.counter }}" class="osmd-container h-32 overflow-hidden">
                                    <p class="text-center text-gray-500 py-4">
                                        <i class="fas fa-music"></i>
                                        Archivo XML/MXL disponible (OpenSheetMusicDisplay no configurado)
                                    </p>
                                </div>
                                <!-- OpenSheetMusicDisplay temporalmente deshabilitado -->
                                <script>
                                    /*
                                    var osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer{{ forloop.counter }}");
                                    osmd.setOptions({
                                        backend: "svg",
                                        drawTitle: false,
                                        drawSubtitle: false,
                                        drawLyricist: false,
                                        drawComposer: false,
                                        drawPartNames: false,
                                        useXMLMeasureNumbers: false,
                                        drawUpToMeasureNumber: 8,
                                    });
                                    osmd.load("{{ music_item.mxml_file.file.url|escapejs }}")
                                        .then(function () {
                                            osmd.render();
                                            var osmdContainer = document.getElementById("osmdContainer{{ forloop.counter }}");
                                            var svgElement = osmdContainer.querySelector("svg");
                                            if (svgElement) {
                                                svgElement.style.transform = "translateY(-30%)";
                                                svgElement.style.position = "relative";
                                                svgElement.style.top = "50%";
                                            }
                                        });
                                    */
                                    console.log("OpenSheetMusicDisplay deshabilitado para:", "{{ music_item.mxml_file.file.url|escapejs }}");
                                </script>
                            </div>
                        {% elif music_item.pdf_file %}
                            <div class="bg-base-200 rounded-lg p-2">
                                <embed src="{{ music_item.pdf_file.file.url }}" type="application/pdf" class="w-full h-64 rounded">
                            </div>
                        {% elif music_item.first_embed %}
                            <div class="bg-base-200 rounded-lg p-2">
                                <iframe src="{{ music_item.first_embed.url }}" class="w-full h-64 rounded"></iframe>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock content %}
