{% extends "music_cards/music_cards_base.html" %}

{% load static %}

{% block title %}Elementos Musicales - Music Cards{% endblock title %}

{% block content %}

<div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold">
                <i class="fas fa-music mr-2 text-primary"></i>
                Elementos Musicales
            </h1>
            <p class="text-base-content/70 mt-1">Gestiona tu biblioteca de contenido musical</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="badge badge-primary badge-lg">{{ music_items|length }} elementos</div>
            {% if request.user.is_authenticated %}
            <a href="{% url 'music_cards:music_item_create' %}" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>Crear Elemento
            </a>
            {% endif %}
        </div>
    </div>
    <div class="space-y-6">
        {% for music_item in music_items %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex items-start gap-4">
                    <div class="flex-1">
                        <h3 class="card-title text-2xl mb-2">{{ music_item.title }}</h3>
                        <div class="flex gap-2 mb-4">
                            <a href="{% url 'music_cards:music_item_detail' music_item.id %}" class="btn btn-sm btn-outline btn-info">
                                <i class="fas fa-eye mr-1"></i>
                                Ver
                            </a>
                            {% if music_item.created_by == request.user or request.user.is_staff %}
                                <a href="{% url 'music_cards:music_item_edit' music_item.id %}" class="btn btn-sm btn-outline btn-warning">
                                    <i class="fas fa-edit mr-1"></i>
                                    Editar
                                </a>
                                <a href="{% url 'music_cards:music_item_delete' music_item.id %}" class="btn btn-sm btn-outline btn-error">
                                    <i class="fas fa-trash mr-1"></i>
                                    Eliminar
                                </a>
                            {% endif %}
                        </div>
                        
                        <!-- Tags and metadata -->
                        <div class="flex flex-wrap gap-2 mb-2">
                            {% for tag in music_item.tags.all %}
                            <span class="badge badge-outline badge-sm">{{ tag.key }}: {{ tag.value }}</span>
                            {% endfor %}
                            {% if music_item.is_template %}
                            <span class="badge badge-primary badge-sm">Plantilla</span>
                            {% endif %}
                        </div>
                        
                        <div class="text-sm text-base-content/70">
                            <div>Creado por: {{ music_item.created_by.username }}</div>
                            <div>{{ music_item.created_at|date:"d/m/Y H:i" }}</div>
                            <div>
                                <i class="fas fa-file-text mr-1"></i>{{ music_item.texts.count }} textos
                                <i class="fas fa-file ml-2 mr-1"></i>{{ music_item.files.count }} archivos
                                <i class="fas fa-link ml-2 mr-1"></i>{{ music_item.embeds.count }} enlaces
                            </div>
                        </div>
                    </div>
                    <div class="flex-[2]">
                        {% if music_item.texts.exists %}
                            {% for text in music_item.texts.all|slice:":1" %}
                            <div class="bg-base-200 rounded-lg p-4">
                                <h4 class="font-semibold mb-2">{{ text.name }}</h4>
                                <!-- Detectar si es ChordPro (contiene acordes entre corchetes) -->
                                {% if '[' in text.content and ']' in text.content %}
                                <div class="chordpro-container bg-white p-3 rounded border text-sm font-mono"
                                     data-chordpro-content="{{ text.content }}">
                                    {{ text.content|linebreaks }}
                                </div>
                                <!-- Detectar si es ABC notation (contiene X:) -->
                                {% elif 'X:' in text.content %}
                                <div id="abc-container{{ forloop.counter }}" 
                                     data-abc-content="{{ text.content|safe }}"
                                     class="abc-notation-container bg-white p-3 rounded border">
                                </div>
                                {% else %}
                                <!-- Texto normal -->
                                <div class="prose max-w-none bg-white p-3 rounded border">
                                    {{ text.content|truncatewords:50|linebreaks }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% elif music_item.files.exists %}
                            {% for file in music_item.files.all|slice:":1" %}
                            <div class="bg-base-200 rounded-lg p-4">
                                <h4 class="font-semibold mb-2">{{ file.name }}</h4>
                                {% if file.file.name|slice:"-4:" == ".pdf" %}
                                <div class="bg-white rounded border h-32 flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-4xl text-red-500"></i>
                                    <span class="ml-2">Archivo PDF</span>
                                </div>
                                {% elif file.file.name|slice:"-4:" in ".jpg,.png,.gif" or file.file.name|slice:"-5:" in ".jpeg,.webp" %}
                                <div class="bg-white rounded border">
                                    <img src="{{ file.file.url }}" alt="{{ file.name }}" class="w-full h-32 object-cover rounded">
                                </div>
                                {% elif file.file.name|slice:"-4:" in ".mp3,.wav,.m4a" %}
                                <div class="bg-white rounded border h-32 flex items-center justify-center">
                                    <i class="fas fa-music text-4xl text-blue-500"></i>
                                    <span class="ml-2">Archivo de Audio</span>
                                </div>
                                {% elif file.file.name|slice:"-4:" in ".mp4,.mov,.avi" %}
                                <div class="bg-white rounded border h-32 flex items-center justify-center">
                                    <i class="fas fa-video text-4xl text-green-500"></i>
                                    <span class="ml-2">Archivo de Video</span>
                                </div>
                                {% else %}
                                <div class="bg-white rounded border h-32 flex items-center justify-center">
                                    <i class="fas fa-file text-4xl text-gray-500"></i>
                                    <span class="ml-2">{{ file.file.name|slice:"-10:" }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% elif music_item.embeds.exists %}
                            {% for embed in music_item.embeds.all|slice:":1" %}
                            <div class="bg-base-200 rounded-lg p-4">
                                <h4 class="font-semibold mb-2">{{ embed.name }}</h4>
                                <div class="bg-white rounded border h-32 flex items-center justify-center">
                                    <i class="fas fa-link text-4xl text-purple-500"></i>
                                    <span class="ml-2">Enlace Externo</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="bg-base-200 rounded-lg p-4 h-32 flex items-center justify-center">
                                <div class="text-center text-base-content/50">
                                    <i class="fas fa-music text-2xl mb-2"></i>
                                    <p>Sin contenido</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-12">
            <i class="fas fa-music text-6xl text-base-content/30 mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">No hay elementos musicales</h3>
            <p class="text-base-content/70 mb-4">Crea tu primer elemento musical para comenzar.</p>
            {% if request.user.is_authenticated %}
            <a href="{% url 'music_cards:music_item_create' %}" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>Crear Primer Elemento
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock content %}
