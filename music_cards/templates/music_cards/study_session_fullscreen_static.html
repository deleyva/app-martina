{% extends "music_cards/base.html" %}
{% load static %}

{% block extra_head %}
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // Configure PDF.js worker
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
</script>
{% endblock %}

{% block content %}
<!-- Fullscreen Study Interface - Static Version -->
<div class="fullscreen-study">
    <!-- Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>
    
    <!-- Hover zones for controls -->
    <div class="hover-zone hover-zone-top" id="hover-zone-top"></div>
    <div class="hover-zone hover-zone-bottom" id="hover-zone-bottom"></div>
    
    <!-- Header with controls -->
    <div class="study-header" id="study-header">
        <div class="header-content">
            <div class="header-left">
                <a href="{% url 'music_cards:study_session_new' study_session.id %}" class="btn btn-sm btn-ghost text-white">
                    <i class="fas fa-times"></i> Salir
                </a>
                <h1 class="study-title" id="study-title">Cargando...</h1>
            </div>
            <div class="header-right">
                <span class="progress-text" id="progress-text">1 / {{ total_items }}</span>
                <span class="box-indicator" id="box-indicator">Box: 1</span>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="study-content" id="study-content">
        <div class="content-container" id="content-container">
            <div class="loading-message">
                <p>Cargando contenido...</p>
            </div>
        </div>
    </div>
    
    <!-- Bottom Controls -->
    <div class="study-controls" id="study-controls">
        <div class="controls-content">
            <!-- Navigation -->
            <div class="navigation-controls">
                <button class="nav-btn nav-prev" id="nav-prev" onclick="navigatePrev()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <span class="nav-counter" id="nav-counter">1 / {{ total_items }}</span>
                
                <button class="nav-btn nav-next" id="nav-next" onclick="navigateNext()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <!-- Rating -->
            <div class="rating-controls">
                <span class="rating-label">¿Qué tal lo sabes?</span>
                <div class="rating-buttons">
                    <button class="rating-btn" onclick="rateItem(1)">1★</button>
                    <button class="rating-btn" onclick="rateItem(2)">2★</button>
                    <button class="rating-btn" onclick="rateItem(3)">3★</button>
                    <button class="rating-btn" onclick="rateItem(4)">4★</button>
                    <button class="rating-btn" onclick="rateItem(5)">5★</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Study Data -->
<script>
const STUDY_DATA = {
    sessionId: {{ study_session.id }},
    currentIndex: {{ current_index }},
    totalItems: {{ total_items }},
    items: [
        {% for review in user_reviews %}
        {
            id: {{ review.id }},
            title: "{{ review.music_item.title|escapejs }}",
            box: {{ review.box }},
            {% if review.music_item.texts.all %}
                {% with review.music_item.texts.all.0 as first_text %}
                type: "text",
                content: `{{ first_text.content|escapejs }}`,
                isABC: {% if 'X:' in first_text.content %}true{% else %}false{% endif %}
                {% endwith %}
            {% elif review.music_item.files.all %}
                {% with review.music_item.files.all.0 as first_file %}
                type: "{% if '.pdf' in first_file.file.name %}pdf{% elif first_file.file.name|slice:'-4:' in '.mp3,.wav,.m4a' %}audio{% else %}video{% endif %}",
                url: "{{ first_file.file.url }}",
                name: "{{ first_file.name|escapejs }}"
                {% endwith %}
            {% else %}
                type: "empty",
                content: "No hay contenido disponible"
            {% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
};
</script>

<!-- Styles -->
<style>
.fullscreen-study {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    color: white;
    overflow: hidden;
    z-index: 9999;
}

/* Progress Bar */
.progress-bar-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.2);
    z-index: 10;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    transition: width 0.3s ease;
    width: 0%;
}

/* Header */
.study-header {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
    padding: 20px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.study-title {
    font-size: 1.5rem;
    font-weight: bold;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.progress-text, .box-indicator {
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Main Content */
.study-content {
    width: 100%;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    box-sizing: border-box;
}

.study-content.fullscreen-content {
    padding: 0;
}

.content-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Content Types */
.text-content {
    width: 100%;
    height: 100%;
    background: white;
    color: black;
    padding: 0.5rem;
    max-height: 100vh;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.text-content.abc-content {
    padding: 1rem;
    max-width: calc(100vw - 2rem);
    background: white;
    overflow: auto;
}

.text-content.abc-content .abc-notation {
    width: 100% !important;
    height: auto !important;
    min-height: calc(100vh - 2rem);
}

.text-content.abc-content .abc-notation svg {
    width: 100% !important;
    height: auto !important;
    max-width: none !important;
}

.text-content.chord-content {
    padding: 1rem;
    background: white;
    overflow: auto;
}

.pdf-content {
    width: 100%;
    height: 100vh;
    padding: 0;
    margin: 0;
    position: relative;
    overflow: hidden;
    background: white;
    touch-action: pan-y; /* Allow vertical touch scrolling */
}

.pdf-canvas {
    width: 100%;
    height: auto;
    display: block;
    margin: 0;
    padding: 0;
    transition: transform 0.3s ease;
}

.pdf-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5rem;
    color: #666;
}

.pdf-progress {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 100px;
    height: 4px;
    background: rgba(0,0,0,0.3);
    border-radius: 2px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.pdf-progress.show {
    opacity: 1;
}

.pdf-progress-bar {
    height: 100%;
    background: #3b82f6;
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0%;
}

.audio-content, .video-content {
    text-align: center;
}

.audio-player, .video-player {
    max-width: 90%;
    max-height: 70vh;
}

.media-info {
    margin-top: 2rem;
}

.media-info h3 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.media-info p {
    font-size: 1.2rem;
    opacity: 0.8;
}

.loading-message, .no-content {
    text-align: center;
    font-size: 1.5rem;
    opacity: 0.6;
}

/* Bottom Controls */
.study-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    padding: 20px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
}

.controls-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.navigation-controls {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.nav-btn {
    background: #3b82f6;
    color: white;
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.nav-btn:hover:not(:disabled) {
    background: #2563eb;
    transform: scale(1.1);
}

.nav-btn:disabled {
    background: #6b7280;
    cursor: not-allowed;
}

.nav-counter {
    font-size: 1.2rem;
    font-weight: bold;
    min-width: 100px;
    text-align: center;
}

.rating-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.rating-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

.rating-buttons {
    display: flex;
    gap: 0.5rem;
}

.rating-btn {
    background: #f59e0b;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.rating-btn:hover {
    background: #d97706;
    transform: scale(1.05);
}

/* Hover zones for precise control activation */
.hover-zone {
    position: fixed;
    z-index: 998;
    pointer-events: auto;
}

.hover-zone-top {
    top: 0;
    left: 0;
    width: 100%;
    height: 100px; /* Top 100px of screen */
}

.hover-zone-bottom {
    bottom: 0;
    left: 0;
    width: 100%;
    height: 120px; /* Bottom 120px of screen */
}

/* Show controls only on specific hover zones */
.hover-zone-top:hover ~ .study-header {
    opacity: 1;
}

.hover-zone-bottom:hover ~ .study-controls {
    opacity: 1;
}

/* Keep controls visible when hovering over them directly */
.study-header:hover,
.study-controls:hover {
    opacity: 1;
}

/* Ensure controls are always on top */
.study-header,
.study-controls {
    position: fixed !important;
    z-index: 999 !important;
}

/* Fullscreen content adjustments */
.fullscreen-content .content-container {
    padding: 0;
    margin: 0;
}

/* ABC notation specific styles for fullscreen */
.abc-content {
    align-items: flex-start !important;
    justify-content: flex-start !important;
}

/* PDF specific styles for fullscreen */
.pdf-content {
    position: relative;
    z-index: 1;
}
</style>

<!-- JavaScript -->
<script>
let currentIndex = STUDY_DATA.currentIndex;
const totalItems = STUDY_DATA.totalItems;
const items = STUDY_DATA.items;

// PDF navigation variables
let currentPDF = null;
let currentPage = 1;
let totalPages = 0;
let currentScrollOffset = 0; // Current vertical offset in pixels
let pdfScale = 1.5;
let pdfCanvas = null;
let pdfContainer = null;
let viewportHeight = 0;
let pdfPageHeight = 0;
let maxScrollOffset = 0;
let overlapPercentage = 0.25; // 25% overlap between views

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Enter fullscreen
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(function(err) {
            console.log('Fullscreen failed:', err);
        });
    }
    
    // Load current item
    loadCurrentItem();
    
    // Setup hover zones
    setupHoverZones();
    
    // Setup scroll and touch events
    setupScrollEvents();
});

function setupHoverZones() {
    const topZone = document.getElementById('hover-zone-top');
    const bottomZone = document.getElementById('hover-zone-bottom');
    const header = document.getElementById('study-header');
    const controls = document.getElementById('study-controls');
    
    let headerTimer, controlsTimer;
    
    // Top zone hover
    topZone.addEventListener('mouseenter', function() {
        clearTimeout(headerTimer);
        header.style.opacity = '1';
    });
    
    topZone.addEventListener('mouseleave', function() {
        headerTimer = setTimeout(() => {
            if (!header.matches(':hover')) {
                header.style.opacity = '0';
            }
        }, 500);
    });
    
    // Bottom zone hover
    bottomZone.addEventListener('mouseenter', function() {
        clearTimeout(controlsTimer);
        controls.style.opacity = '1';
    });
    
    bottomZone.addEventListener('mouseleave', function() {
        controlsTimer = setTimeout(() => {
            if (!controls.matches(':hover')) {
                controls.style.opacity = '0';
            }
        }, 500);
    });
    
    // Keep controls visible when hovering directly
    header.addEventListener('mouseenter', function() {
        clearTimeout(headerTimer);
    });
    
    header.addEventListener('mouseleave', function() {
        headerTimer = setTimeout(() => {
            header.style.opacity = '0';
        }, 500);
    });
    
    controls.addEventListener('mouseenter', function() {
        clearTimeout(controlsTimer);
    });
    
    controls.addEventListener('mouseleave', function() {
        controlsTimer = setTimeout(() => {
            controls.style.opacity = '0';
        }, 500);
    });
}

function setupScrollEvents() {
    let scrollTimeout;
    let touchStartY = 0;
    let touchEndY = 0;
    let isScrolling = false;
    
    // Wheel event (mouse wheel, trackpad) - smooth scrolling
    document.addEventListener('wheel', function(e) {
        const currentItem = items[currentIndex];
        
        // Only handle scroll for PDFs
        if (currentItem && currentItem.type === 'pdf' && currentPDF) {
            e.preventDefault();
            
            // Use smooth scrolling for natural feel
            smoothScrollPDF(e.deltaY);
        }
    }, { passive: false });
    
    // Touch events (mobile/tablet)
    document.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchend', function(e) {
        const currentItem = items[currentIndex];
        
        // Only handle touch for PDFs
        if (currentItem && currentItem.type === 'pdf' && currentPDF) {
            touchEndY = e.changedTouches[0].clientY;
            const touchDiff = touchStartY - touchEndY;
            
            // Minimum swipe distance to trigger navigation
            const minSwipeDistance = 50;
            
            if (Math.abs(touchDiff) > minSwipeDistance) {
                if (touchDiff > 0) {
                    // Swipe up (scroll down)
                    navigateNext();
                } else {
                    // Swipe down (scroll up)
                    navigatePrev();
                }
            }
        }
    }, { passive: true });
    
    // Keyboard scroll events (Page Up/Down, Space) - smart jumps
    document.addEventListener('keydown', function(e) {
        const currentItem = items[currentIndex];
        
        if (currentItem && currentItem.type === 'pdf' && currentPDF) {
            if (e.key === 'PageDown' || e.key === ' ') {
                e.preventDefault();
                scrollPDFDown();
            } else if (e.key === 'PageUp') {
                e.preventDefault();
                scrollPDFUp();
            }
        }
    });
}

function loadCurrentItem() {
    const item = items[currentIndex];
    if (!item) return;
    
    console.log('Loading item:', currentIndex, item);
    
    // Update UI
    updateUI(item);
    
    // Load content
    loadContent(item);
}

function updateUI(item) {
    // Update title
    document.getElementById('study-title').textContent = item.title;
    
    // Update progress
    const progress = ((currentIndex + 1) / totalItems) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    
    // Update counters
    document.getElementById('progress-text').textContent = `${currentIndex + 1} / ${totalItems}`;
    document.getElementById('nav-counter').textContent = `${currentIndex + 1} / ${totalItems}`;
    
    // Update box
    document.getElementById('box-indicator').textContent = `Box: ${item.box}`;
    
    // Update navigation buttons
    document.getElementById('nav-prev').disabled = currentIndex === 0;
    document.getElementById('nav-next').disabled = currentIndex >= totalItems - 1;
}

function loadContent(item) {
    const container = document.getElementById('content-container');
    const studyContent = document.getElementById('study-content');
    
    // Reset study-content classes
    studyContent.classList.remove('fullscreen-content');
    
    if (item.type === 'text') {
        if (item.isABC) {
            // ABC Notation - fullscreen with minimal border
            studyContent.classList.add('fullscreen-content');
            container.innerHTML = `
                <div class="text-content abc-content">
                    <div class="abc-notation" id="abc-notation" style="width: 100%; height: 100%;"></div>
                </div>
            `;
            
            setTimeout(() => {
                if (window.ABCJS) {
                    ABCJS.renderAbc('abc-notation', item.content, {
                        responsive: "resize",
                        viewportHorizontal: true,
                        scrollHorizontal: true,
                        scale: 1.2,
                        staffwidth: window.innerWidth - 40
                    });
                }
            }, 100);
        } else {
            // Chord Sheet - normal padding
            container.innerHTML = `
                <div class="text-content chord-content">
                    <div class="chord-sheet" id="chord-sheet"></div>
                </div>
            `;
            
            setTimeout(() => {
                const chordElement = document.getElementById('chord-sheet');
                if (window.parseUltimateGuitarChords) {
                    chordElement.innerHTML = parseUltimateGuitarChords(item.content);
                } else {
                    chordElement.innerHTML = item.content.replace(/\n/g, '<br>');
                }
            }, 100);
        }
    } else if (item.type === 'pdf') {
        // PDF - completely fullscreen like forScore with custom navigation
        studyContent.classList.add('fullscreen-content');
        container.innerHTML = `
            <div class="pdf-content" id="pdf-container">
                <canvas id="pdf-canvas" class="pdf-canvas"></canvas>
                <div class="pdf-loading">Cargando PDF...</div>
                <div class="pdf-progress" id="pdf-progress">
                    <div class="pdf-progress-bar" id="pdf-progress-bar"></div>
                </div>
            </div>
        `;
        
        // Load PDF with PDF.js
        loadPDFContent(item.url);
    } else if (item.type === 'audio') {
        container.innerHTML = `
            <div class="audio-content">
                <audio controls class="audio-player">
                    <source src="${item.url}" type="audio/mpeg">
                </audio>
                <div class="media-info">
                    <h3>${item.name}</h3>
                    <p>${item.title}</p>
                </div>
            </div>
        `;
    } else if (item.type === 'video') {
        container.innerHTML = `
            <div class="video-content">
                <video controls class="video-player">
                    <source src="${item.url}" type="video/mp4">
                </video>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="no-content">
                <p>No hay contenido disponible</p>
            </div>
        `;
    }
}

// PDF loading function
async function loadPDFContent(url) {
    try {
        const loadingDiv = document.querySelector('.pdf-loading');
        loadingDiv.textContent = 'Cargando PDF...';
        
        if (window.pdfjsLib) {
            const pdf = await pdfjsLib.getDocument(url).promise;
            currentPDF = pdf;
            totalPages = pdf.numPages;
            currentPage = 1;
            currentScrollOffset = 0;
            
            // Get references to DOM elements
            pdfCanvas = document.getElementById('pdf-canvas');
            pdfContainer = document.getElementById('pdf-container');
            viewportHeight = pdfContainer.clientHeight;
            
            await renderPDFPage();
            calculateScrollLimits();
            loadingDiv.style.display = 'none';
        } else {
            loadingDiv.textContent = 'PDF.js no disponible';
        }
    } catch (error) {
        console.error('Error loading PDF:', error);
        document.querySelector('.pdf-loading').textContent = 'Error cargando PDF';
    }
}

async function renderPDFPage() {
    if (!currentPDF || !pdfCanvas || !pdfContainer) return;
    
    try {
        const page = await currentPDF.getPage(currentPage);
        const context = pdfCanvas.getContext('2d');
        
        // Calculate scale to fit full width (no margins)
        const viewport = page.getViewport({ scale: 1 });
        const containerWidth = pdfContainer.clientWidth;
        const scale = containerWidth / viewport.width;
        
        const scaledViewport = page.getViewport({ scale: scale });
        
        // Set canvas dimensions to match scaled PDF
        pdfCanvas.width = scaledViewport.width;
        pdfCanvas.height = scaledViewport.height;
        
        // Store PDF page height for scroll calculations
        pdfPageHeight = scaledViewport.height;
        
        // Render page
        await page.render({
            canvasContext: context,
            viewport: scaledViewport
        }).promise;
        
        // Apply current scroll position
        updatePDFPosition();
        
        console.log(`PDF rendered - Page: ${currentPage}, Canvas: ${pdfCanvas.width}x${pdfCanvas.height}, Viewport: ${viewportHeight}`);
        
    } catch (error) {
        console.error('Error rendering PDF page:', error);
    }
}

function calculateScrollLimits() {
    if (!pdfCanvas || !pdfContainer) return;
    
    viewportHeight = pdfContainer.clientHeight;
    
    // Maximum scroll offset: PDF height minus viewport height
    // This ensures the bottom of the PDF aligns with the bottom of the viewport
    maxScrollOffset = Math.max(0, pdfPageHeight - viewportHeight);
    
    console.log(`Scroll limits calculated - PDF Height: ${pdfPageHeight}, Viewport: ${viewportHeight}, Max Offset: ${maxScrollOffset}`);
}

function updatePDFPosition() {
    if (!pdfCanvas || !pdfContainer) return;
    
    // Clamp scroll offset to valid range
    currentScrollOffset = Math.max(0, Math.min(currentScrollOffset, maxScrollOffset));
    
    // Apply transform to show current position
    pdfCanvas.style.transform = `translateY(-${currentScrollOffset}px)`;
    
    // Update progress bar
    updateProgressBar();
    
    console.log(`PDF Position - Offset: ${currentScrollOffset}/${maxScrollOffset}px`);
}

function updateProgressBar() {
    const progressBar = document.getElementById('pdf-progress-bar');
    const progress = document.getElementById('pdf-progress');
    
    if (progressBar && progress && maxScrollOffset > 0) {
        const progressPercent = (currentScrollOffset / maxScrollOffset) * 100;
        progressBar.style.width = progressPercent + '%';
        
        // Show progress briefly
        progress.classList.add('show');
        setTimeout(() => {
            progress.classList.remove('show');
        }, 1500);
    }
}

function scrollPDFDown(amount = null) {
    if (!pdfCanvas || maxScrollOffset <= 0) return false;
    
    // Calculate smart jump with overlap
    const jumpAmount = amount || (viewportHeight * (1 - overlapPercentage));
    const newOffset = currentScrollOffset + jumpAmount;
    
    if (newOffset <= maxScrollOffset) {
        currentScrollOffset = newOffset;
        updatePDFPosition();
        return true; // Handled within current page
    } else if (currentPage < totalPages) {
        // Move to next page
        currentPage++;
        currentScrollOffset = 0;
        renderPDFPage().then(() => {
            calculateScrollLimits();
        });
        return true; // Handled within PDF
    }
    
    return false; // Need to go to next item
}

function scrollPDFUp(amount = null) {
    if (!pdfCanvas) return false;
    
    // Calculate smart jump with overlap
    const jumpAmount = amount || (viewportHeight * (1 - overlapPercentage));
    const newOffset = currentScrollOffset - jumpAmount;
    
    if (newOffset >= 0) {
        currentScrollOffset = newOffset;
        updatePDFPosition();
        return true; // Handled within current page
    } else if (currentPage > 1) {
        // Move to previous page, position at bottom
        currentPage--;
        renderPDFPage().then(() => {
            calculateScrollLimits();
            currentScrollOffset = maxScrollOffset;
            updatePDFPosition();
        });
        return true; // Handled within PDF
    }
    
    return false; // Need to go to previous item
}

function smoothScrollPDF(deltaY) {
    if (!pdfCanvas || maxScrollOffset <= 0) return false;
    
    // Convert wheel delta to scroll amount (adjust sensitivity)
    const scrollAmount = deltaY * 2;
    const newOffset = currentScrollOffset + scrollAmount;
    
    if (newOffset >= 0 && newOffset <= maxScrollOffset) {
        currentScrollOffset = newOffset;
        updatePDFPosition();
        return true;
    } else if (newOffset > maxScrollOffset && currentPage < totalPages) {
        // Auto-advance to next page when scrolling past bottom
        currentPage++;
        currentScrollOffset = 0;
        renderPDFPage().then(() => {
            calculateScrollLimits();
        });
        return true;
    } else if (newOffset < 0 && currentPage > 1) {
        // Auto-go to previous page when scrolling past top
        currentPage--;
        renderPDFPage().then(() => {
            calculateScrollLimits();
            currentScrollOffset = maxScrollOffset;
            updatePDFPosition();
        });
        return true;
    }
    
    return false;
}

// Remove old third-based navigation functions - replaced by scroll-based system

function navigatePrev() {
    const currentItem = items[currentIndex];
    
    if (currentItem && currentItem.type === 'pdf') {
        if (!scrollPDFUp()) {
            // Go to previous item
            if (currentIndex > 0) {
                currentIndex--;
                loadCurrentItem();
            }
        }
    } else {
        // Normal navigation for non-PDF items
        if (currentIndex > 0) {
            currentIndex--;
            loadCurrentItem();
        }
    }
}

function navigateNext() {
    const currentItem = items[currentIndex];
    
    if (currentItem && currentItem.type === 'pdf') {
        if (!scrollPDFDown()) {
            // Go to next item
            if (currentIndex < totalItems - 1) {
                currentIndex++;
                loadCurrentItem();
            }
        }
    } else {
        // Normal navigation for non-PDF items
        if (currentIndex < totalItems - 1) {
            currentIndex++;
            loadCurrentItem();
        }
    }
}

function rateItem(rating) {
    const item = items[currentIndex];
    console.log('Rating item:', item.id, 'with rating:', rating);
    
    // Send rating to server
    fetch('{% url "music_cards:rate_item" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `review_id=${item.id}&rating=${rating}`
    }).then(response => {
        if (response.ok) {
            // Update local data
            item.box = rating;
            document.getElementById('box-indicator').textContent = `Box: ${rating}`;
            console.log('Rating updated successfully');
        }
    }).catch(err => {
        console.error('Rating failed:', err);
    });
}

// Keyboard navigation - same logic as buttons
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        navigatePrev();
        e.preventDefault();
    } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        navigateNext();
        e.preventDefault();
    } else if (e.key === 'Escape') {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
        window.location.href = '{% url "music_cards:study_session_new" study_session.id %}';
        e.preventDefault();
    }
});
</script>

{% csrf_token %}
{% endblock content %}
