{% extends "music_cards/music_cards_base.html" %}

{% block title %}
    {% if music_item %}Editar{% else %}Crear{% endif %} Elemento Musical - Music Cards
{% endblock title %}

{% block content %}
<div class="container mx-auto max-w-4xl">
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold">
                    <i class="fas fa-music mr-2 text-primary"></i>
                    {% if music_item %}Editar{% else %}Crear{% endif %} Elemento Musical
                </h1>
                <a href="{% url 'music_cards:music_items_list' %}" class="btn btn-outline">
                    <i class="fas fa-arrow-left mr-2"></i>Volver a la lista
                </a>
            </div>

            <form method="post" enctype="multipart/form-data" x-data="musicItemForm()">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Título *</span>
                        </label>
                        <input type="text" 
                               name="title" 
                               value="{{ music_item.title|default:'' }}"
                               class="input input-bordered w-full" 
                               placeholder="Nombre del elemento musical"
                               required>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Visibilidad</span>
                        </label>
                        <select name="visibility" class="select select-bordered w-full">
                            <option value="private" {% if music_item.visibility == 'private' %}selected{% endif %}>
                                Privado
                            </option>
                            <option value="shared" {% if music_item.visibility == 'shared' %}selected{% endif %}>
                                Compartido con profesores
                            </option>
                            <option value="public" {% if music_item.visibility == 'public' %}selected{% endif %}>
                                Público
                            </option>
                            <option value="course_only" {% if music_item.visibility == 'course_only' %}selected{% endif %}>
                                Solo para mi curso
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Tags Section -->
                <div class="mb-6" x-data="tagsManager()">
                    <label class="label">
                        <span class="label-text font-semibold">Etiquetas</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Style Tags -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Estilo</span>
                            </label>
                            <div class="flex gap-2">
                                <select name="style_tag" class="select select-bordered select-sm flex-1" x-model="selectedStyle">
                                    <option value="">Seleccionar estilo...</option>
                                    {% for tag in style_tags %}
                                    <option value="{{ tag.id }}" 
                                            {% if tag in music_item.tags.all %}selected{% endif %}>
                                        {{ tag.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" @click="showNewStyleForm = !showNewStyleForm" 
                                        class="btn btn-sm btn-outline">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div x-show="showNewStyleForm" class="mt-2" x-transition>
                                <input type="text" x-model="newStyleValue" 
                                       class="input input-bordered input-sm w-full" 
                                       placeholder="Nuevo estilo (ej: Jazz, Rock, Clásico)">
                                <input type="hidden" name="new_style_value" :value="newStyleValue">
                            </div>
                        </div>

                        <!-- Instrument Tags -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Instrumento</span>
                            </label>
                            <div class="flex gap-2">
                                <select name="instrument_tag" class="select select-bordered select-sm flex-1" x-model="selectedInstrument">
                                    <option value="">Seleccionar instrumento...</option>
                                    {% for tag in instrument_tags %}
                                    <option value="{{ tag.id }}"
                                            {% if tag in music_item.tags.all %}selected{% endif %}>
                                        {{ tag.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" @click="showNewInstrumentForm = !showNewInstrumentForm" 
                                        class="btn btn-sm btn-outline">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div x-show="showNewInstrumentForm" class="mt-2" x-transition>
                                <input type="text" x-model="newInstrumentValue" 
                                       class="input input-bordered input-sm w-full" 
                                       placeholder="Nuevo instrumento (ej: Guitarra, Piano, Violín)">
                                <input type="hidden" name="new_instrument_value" :value="newInstrumentValue">
                            </div>
                        </div>

                        <!-- Difficulty Tags -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Dificultad</span>
                            </label>
                            <div class="flex gap-2">
                                <select name="difficulty_tag" class="select select-bordered select-sm flex-1" x-model="selectedDifficulty">
                                    <option value="">Seleccionar dificultad...</option>
                                    <option value="1">Principiante</option>
                                    <option value="2">Intermedio</option>
                                    <option value="3">Avanzado</option>
                                    <option value="4">Experto</option>
                                </select>
                                <button type="button" @click="showNewDifficultyForm = !showNewDifficultyForm" 
                                        class="btn btn-sm btn-outline">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div x-show="showNewDifficultyForm" class="mt-2" x-transition>
                                <input type="text" x-model="newDifficultyValue" 
                                       class="input input-bordered input-sm w-full" 
                                       placeholder="Nueva dificultad personalizada">
                                <input type="hidden" name="new_difficulty_value" :value="newDifficultyValue">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Tags Section -->
                    <div class="mt-4">
                        <label class="label">
                            <span class="label-text">Etiquetas Personalizadas</span>
                        </label>
                        <div class="space-y-2">
                            <template x-for="(tag, index) in customTags" :key="index">
                                <div class="flex gap-2">
                                    <input type="text" :name="'custom_tag_key_' + index" x-model="tag.key"
                                           class="input input-bordered input-sm flex-1" 
                                           placeholder="Clave (ej: género, tempo)">
                                    <input type="text" :name="'custom_tag_value_' + index" x-model="tag.value"
                                           class="input input-bordered input-sm flex-1" 
                                           placeholder="Valor (ej: balada, 120bpm)">
                                    <button type="button" @click="removeCustomTag(index)" 
                                            class="btn btn-sm btn-error btn-circle">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                            <button type="button" @click="addCustomTag()" class="btn btn-sm btn-outline">
                                <i class="fas fa-plus mr-1"></i>Añadir Etiqueta Personalizada
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Content Sections -->
                <div class="tabs tabs-boxed mb-6">
                    <a class="tab tab-active" @click="activeTab = 'texts'" :class="{ 'tab-active': activeTab === 'texts' }">
                        <i class="fas fa-file-text mr-2"></i>Textos
                    </a>
                    <a class="tab" @click="activeTab = 'files'" :class="{ 'tab-active': activeTab === 'files' }">
                        <i class="fas fa-file mr-2"></i>Archivos
                    </a>
                    <a class="tab" @click="activeTab = 'embeds'" :class="{ 'tab-active': activeTab === 'embeds' }">
                        <i class="fas fa-link mr-2"></i>Enlaces
                    </a>
                </div>

                <!-- Texts Tab -->
                <div x-show="activeTab === 'texts'" class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Contenido Textual</h3>
                        <button type="button" @click="addText()" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus mr-1"></i>Añadir Texto
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <template x-for="(text, index) in texts" :key="index">
                            <div class="card bg-base-200 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <input type="text" 
                                               :name="'text_name_' + index"
                                               x-model="text.name"
                                               class="input input-bordered input-sm flex-1 mr-2" 
                                               placeholder="Nombre del texto">
                                        <button type="button" @click="removeText(index)" class="btn btn-sm btn-error btn-circle">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <textarea :name="'text_content_' + index"
                                              x-model="text.content"
                                              class="textarea textarea-bordered w-full h-32" 
                                              placeholder="Contenido del texto (soporta ChordPro y ABC notation)"></textarea>
                                    <div class="form-control">
                                        <label class="label cursor-pointer">
                                            <span class="label-text">Con derechos de autor</span>
                                            <input type="checkbox" 
                                                   :name="'text_copyrighted_' + index"
                                                   x-model="text.copyrighted"
                                                   class="checkbox checkbox-primary" />
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="texts.length === 0" class="text-center py-8 text-base-content/50">
                            <i class="fas fa-file-text text-4xl mb-2"></i>
                            <p>No hay textos añadidos. Haz clic en "Añadir Texto" para empezar.</p>
                        </div>
                    </div>
                </div>

                <!-- Files Tab -->
                <div x-show="activeTab === 'files'" class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Archivos</h3>
                        <button type="button" @click="addFile()" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus mr-1"></i>Añadir Archivo
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <template x-for="(file, index) in files" :key="index">
                            <div class="card bg-base-200 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <input type="text" 
                                               :name="'file_name_' + index"
                                               x-model="file.name"
                                               class="input input-bordered input-sm flex-1 mr-2" 
                                               placeholder="Nombre del archivo">
                                        <button type="button" @click="removeFile(index)" class="btn btn-sm btn-error btn-circle">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <input type="file" 
                                           :name="'file_upload_' + index"
                                           class="file-input file-input-bordered w-full"
                                           accept=".pdf,.mp3,.wav,.m4a,.mp4,.mov,.avi,.mxl,.xml,.jpg,.jpeg,.png,.gif,.bmp,.webp,.svg">
                                    <div class="form-control mt-2">
                                        <label class="label cursor-pointer">
                                            <span class="label-text">Con derechos de autor</span>
                                            <input type="checkbox" 
                                                   :name="'file_copyrighted_' + index"
                                                   x-model="file.copyrighted"
                                                   class="checkbox checkbox-primary" />
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="files.length === 0" class="text-center py-8 text-base-content/50">
                            <i class="fas fa-file text-4xl mb-2"></i>
                            <p>No hay archivos añadidos. Haz clic en "Añadir Archivo" para empezar.</p>
                        </div>
                    </div>
                </div>

                <!-- Embeds Tab -->
                <div x-show="activeTab === 'embeds'" class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Enlaces y Embeds</h3>
                        <button type="button" @click="addEmbed()" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus mr-1"></i>Añadir Enlace
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <template x-for="(embed, index) in embeds" :key="index">
                            <div class="card bg-base-200 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <input type="text" 
                                               :name="'embed_name_' + index"
                                               x-model="embed.name"
                                               class="input input-bordered input-sm flex-1 mr-2" 
                                               placeholder="Nombre del enlace">
                                        <button type="button" @click="removeEmbed(index)" class="btn btn-sm btn-error btn-circle">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <input type="url" 
                                           :name="'embed_url_' + index"
                                           x-model="embed.url"
                                           class="input input-bordered w-full" 
                                           placeholder="URL (YouTube, Spotify, etc.)">
                                    <div class="form-control mt-2">
                                        <label class="label cursor-pointer">
                                            <span class="label-text">Con derechos de autor</span>
                                            <input type="checkbox" 
                                                   :name="'embed_copyrighted_' + index"
                                                   x-model="embed.copyrighted"
                                                   class="checkbox checkbox-primary" />
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="embeds.length === 0" class="text-center py-8 text-base-content/50">
                            <i class="fas fa-link text-4xl mb-2"></i>
                            <p>No hay enlaces añadidos. Haz clic en "Añadir Enlace" para empezar.</p>
                        </div>
                    </div>
                </div>

                <!-- Template Options -->
                <div class="form-control mb-6">
                    <label class="label cursor-pointer">
                        <span class="label-text font-semibold">Marcar como plantilla reutilizable</span>
                        <input type="checkbox" 
                               name="is_template"
                               {% if music_item.is_template %}checked{% endif %}
                               class="checkbox checkbox-primary" />
                    </label>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 justify-end">
                    <a href="{% url 'music_cards:music_items_list' %}" class="btn btn-outline">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        {% if music_item %}Actualizar{% else %}Crear{% endif %} Elemento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function musicItemForm() {
    return {
        activeTab: 'texts',
        texts: [
            {% for text in music_item.texts.all %}
            {
                name: '{{ text.name|escapejs }}',
                content: '{{ text.content|escapejs }}',
                copyrighted: {{ text.copyrighted|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        files: [
            {% for file in music_item.files.all %}
            {
                name: '{{ file.name|escapejs }}',
                copyrighted: {{ file.copyrighted|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        embeds: [
            {% for embed in music_item.embeds.all %}
            {
                name: '{{ embed.name|escapejs }}',
                url: '{{ embed.url|escapejs }}',
                copyrighted: {{ embed.copyrighted|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        
        addText() {
            this.texts.push({
                name: '',
                content: '',
                copyrighted: true
            });
        },
        
        removeText(index) {
            this.texts.splice(index, 1);
        },
        
        addFile() {
            this.files.push({
                name: '',
                copyrighted: true
            });
        },
        
        removeFile(index) {
            this.files.splice(index, 1);
        },
        
        addEmbed() {
            this.embeds.push({
                name: '',
                url: '',
                copyrighted: true
            });
        },
        
        removeEmbed(index) {
            this.embeds.splice(index, 1);
        }
    }
}

function tagsManager() {
    return {
        selectedStyle: '',
        selectedInstrument: '',
        selectedDifficulty: '',
        showNewStyleForm: false,
        showNewInstrumentForm: false,
        showNewDifficultyForm: false,
        newStyleValue: '',
        newInstrumentValue: '',
        newDifficultyValue: '',
        customTags: [],
        
        addCustomTag() {
            this.customTags.push({
                key: '',
                value: ''
            });
        },
        
        removeCustomTag(index) {
            this.customTags.splice(index, 1);
        }
    }
}
</script>
{% endblock content %}
