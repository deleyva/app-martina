{% extends "music_cards/music_cards_base.html" %}

{% block title %}Sesión de Estudio - Music Cards{% endblock title %}

{% block content %}
<div class="container mx-auto p-4" x-data="studySession({{ study_session.id }})">
    <!-- Study Session Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold">
                <i class="fas fa-play-circle text-primary mr-2"></i>
                Sesión de Estudio
            </h1>
            <p class="text-base-content/70">{{ user_reviews|length }} elementos para estudiar</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'music_cards:study_session_fullscreen' study_session.id %}" 
               class="btn btn-primary">
                <i class="fas fa-expand mr-2"></i>Pantalla Completa
            </a>
            <button @click="finishSession()" class="btn btn-outline btn-error">
                <i class="fas fa-stop mr-2"></i>Terminar Sesión
            </button>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="mb-6">
        <div class="flex justify-between text-sm mb-2">
            <span>Progreso</span>
            <span x-text="`${currentIndex + 1} / ${totalItems}`"></span>
        </div>
        <progress class="progress progress-primary w-full" 
                  :value="currentIndex + 1" 
                  :max="totalItems"></progress>
    </div>

    <!-- Study Items List -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Items sidebar -->
        <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow-lg">
                <div class="card-body">
                    <h3 class="card-title text-lg">
                        <i class="fas fa-list mr-2"></i>Items
                    </h3>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        {% for review in user_reviews %}
                        <div class="card bg-base-200 shadow-sm cursor-pointer hover:bg-base-300 transition-colors"
                             @click="selectItem({{ forloop.counter0 }})"
                             :class="{ 'ring-2 ring-primary': currentIndex === {{ forloop.counter0 }} }">
                            <div class="card-body p-3">
                                <h4 class="font-semibold text-sm">{{ review.music_item.title }}</h4>
                                <div class="flex items-center justify-between mt-2">
                                    <div class="badge badge-outline badge-sm">
                                        Box {{ review.box }}
                                    </div>
                                    <div class="text-xs text-base-content/70">
                                        {{ review.n_times_reviewed }} veces
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content area -->
        <div class="lg:col-span-3">
            <div class="card bg-base-100 shadow-lg">
                <div class="card-body">
                    {% if user_reviews %}
                        {% for review in user_reviews %}
                        <div x-show="currentIndex === {{ forloop.counter0 }}" 
                             x-transition:enter="transition ease-out duration-300"
                             x-transition:enter-start="opacity-0 transform scale-95"
                             x-transition:enter-end="opacity-100 transform scale-100">
                            
                            <!-- Item header -->
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h2 class="text-2xl font-bold">{{ review.music_item.title }}</h2>
                                    <div class="flex gap-2 mt-2">
                                        {% for tag in review.music_item.tags.all %}
                                        <span class="badge badge-outline">{{ tag.key }}: {{ tag.value }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="badge badge-lg badge-primary">Box {{ review.box }}</div>
                                    <p class="text-sm text-base-content/70 mt-1">
                                        Revisado {{ review.n_times_reviewed }} veces
                                    </p>
                                </div>
                            </div>

                            <!-- Content area -->
                            <div class="bg-base-200 rounded-lg p-6 mb-6 min-h-96">
                                <!-- Text content -->
                                {% for text in review.music_item.texts.all %}
                                <div class="mb-4">
                                    <h4 class="font-semibold mb-2">{{ text.name }}</h4>
                                    <!-- Check if it's ChordPro format -->
                                    {% if '[' in text.content and ']' in text.content %}
                                    <div class="chordpro-container bg-white p-4 rounded border font-mono text-sm"
                                         data-chordpro-content="{{ text.content }}">
                                        {{ text.content|linebreaks }}
                                    </div>
                                    {% else %}
                                    <div class="prose max-w-none">
                                        {{ text.content|linebreaks }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}

                                <!-- ABC notation -->
                                {% for text in review.music_item.texts.all %}
                                {% if 'X:' in text.content %}
                                <div class="mb-4">
                                    <h4 class="font-semibold mb-2">Partitura</h4>
                                    <div class="abc-notation-container bg-white p-4 rounded border"
                                         id="abc-{{ review.id }}-{{ forloop.counter }}"
                                         data-abc-content="{{ text.content }}">
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}

                                <!-- PDF files -->
                                {% for file in review.music_item.files.all %}
                                {% if file.file.name|slice:"-4:" == ".pdf" %}
                                <div class="mb-4">
                                    <h4 class="font-semibold mb-2">{{ file.name }}</h4>
                                    <div class="relative bg-white rounded border" style="height: 500px; overflow: hidden;">
                                        <div id="pdf-{{ review.id }}-{{ forloop.counter }}" class="pdf-container" style="width: 100%; height: 100%; display: flex; flex-direction: column;"></div>
                                        <script>
                                            document.addEventListener('DOMContentLoaded', function() {
                                                initializePDFViewer('{{ file.file.url }}', 'pdf-{{ review.id }}-{{ forloop.counter }}');
                                            });
                                        </script>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}

                                <!-- Audio/Video files -->
                                {% for file in review.music_item.files.all %}
                                {% if file.file.name|slice:"-4:" in ".mp3,.wav,.m4a,.mp4,.mov,.avi" %}
                                <div class="mb-4">
                                    <h4 class="font-semibold mb-2">{{ file.name }}</h4>
                                    {% if file.file.name|slice:"-4:" in ".mp3,.wav,.m4a" %}
                                    <audio controls class="w-full" id="audio-{{ review.id }}-{{ forloop.counter }}">
                                        <source src="{{ file.file.url }}" type="audio/mpeg">
                                        Tu navegador no soporta audio.
                                    </audio>
                                    {% else %}
                                    <video controls class="w-full max-h-96" id="video-{{ review.id }}-{{ forloop.counter }}">
                                        <source src="{{ file.file.url }}" type="video/mp4">
                                        Tu navegador no soporta video.
                                    </video>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}

                                <!-- Embeds -->
                                {% for embed in review.music_item.embeds.all %}
                                <div class="mb-4">
                                    <h4 class="font-semibold mb-2">{{ embed.name }}</h4>
                                    <div class="aspect-video">
                                        <iframe src="{{ embed.url }}" 
                                                class="w-full h-full rounded border"
                                                frameborder="0" 
                                                allowfullscreen>
                                        </iframe>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Rating buttons -->
                            <div class="text-center">
                                <h3 class="text-lg font-semibold mb-4">¿Cómo te ha salido?</h3>
                                <div class="flex justify-center gap-4">
                                    <button @click="rateItem(1)" 
                                            class="leitner-btn box-1"
                                            title="No lo sé">
                                        1<br><small>No lo sé</small>
                                    </button>
                                    <button @click="rateItem(2)" 
                                            class="leitner-btn box-2"
                                            title="Difícil">
                                        2<br><small>Difícil</small>
                                    </button>
                                    <button @click="rateItem(3)" 
                                            class="leitner-btn box-3"
                                            title="Bien">
                                        3<br><small>Bien</small>
                                    </button>
                                    <button @click="rateItem(4)" 
                                            class="leitner-btn box-4"
                                            title="Fácil">
                                        4<br><small>Fácil</small>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-12">
                            <i class="fas fa-music text-6xl text-base-content/30 mb-4"></i>
                            <h3 class="text-xl font-semibold mb-2">No hay elementos para estudiar</h3>
                            <p class="text-base-content/70">Crea algunos elementos musicales para comenzar tu sesión de estudio.</p>
                            <a href="{% url 'music_cards:music_item_create' %}" class="btn btn-primary mt-4">
                                <i class="fas fa-plus mr-2"></i>Crear Elemento
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Study Mode -->
<div x-show="isFullscreen" 
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     class="study-fullscreen"
     style="display: none;">
    
    <!-- Media controls in top-right -->
    <div class="media-controls">
        {% for review in user_reviews %}
        <div x-show="currentIndex === {{ forloop.counter0 }}">
            {% for file in review.music_item.files.all %}
            {% if file.file.name|slice:"-4:" in ".mp3,.wav,.m4a" %}
            <button @click="toggleAudio('audio-fs-{{ review.id }}-{{ forloop.counter }}')" 
                    class="btn btn-circle btn-primary">
                <i class="fas fa-play"></i>
            </button>
            {% elif file.file.name|slice:"-4:" in ".mp4,.mov,.avi" %}
            <button @click="toggleVideo('video-fs-{{ review.id }}-{{ forloop.counter }}')" 
                    class="btn btn-circle btn-primary">
                <i class="fas fa-video"></i>
            </button>
            {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
        <button @click="exitFullscreen()" class="btn btn-circle btn-error">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Main content in fullscreen -->
    <div class="study-content">
        {% for review in user_reviews %}
        <div x-show="currentIndex === {{ forloop.counter0 }}">
            <h1 class="text-4xl font-bold mb-6 text-center">{{ review.music_item.title }}</h1>
            
            <!-- Content optimized for fullscreen -->
            {% for text in review.music_item.texts.all %}
            {% if '[' in text.content and ']' in text.content %}
            <div class="chordpro-container text-2xl leading-relaxed text-center"
                 data-chordpro-content="{{ text.content }}">
            </div>
            {% elif 'X:' in text.content %}
            <div class="abc-notation-container"
                 id="abc-fs-{{ review.id }}-{{ forloop.counter }}"
                 data-abc-content="{{ text.content }}">
            </div>
            {% else %}
            <div class="text-xl leading-relaxed text-center">
                {{ text.content|linebreaks }}
            </div>
            {% endif %}
            {% endfor %}

            <!-- Hidden audio/video for fullscreen controls -->
            {% for file in review.music_item.files.all %}
            {% if file.file.name|slice:"-4:" in ".mp3,.wav,.m4a" %}
            <audio id="audio-fs-{{ review.id }}-{{ forloop.counter }}" style="display: none;">
                <source src="{{ file.file.url }}" type="audio/mpeg">
            </audio>
            {% elif file.file.name|slice:"-4:" in ".mp4,.mov,.avi" %}
            <video id="video-fs-{{ review.id }}-{{ forloop.counter }}" 
                   class="w-full h-auto max-h-full object-contain">
                <source src="{{ file.file.url }}" type="video/mp4">
            </video>
            {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- Control bar at bottom -->
    <div class="study-controls">
        <div class="flex items-center gap-4">
            <button @click="previousItem()" class="btn btn-circle btn-lg">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span class="text-lg" x-text="`${currentIndex + 1} / ${totalItems}`"></span>
            <button @click="nextItem()" class="btn btn-circle btn-lg">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div class="flex items-center">
            <span class="mr-4 text-lg">¿Cómo te ha salido?</span>
            <div class="leitner-buttons">
                <button @click="rateItemFullscreen(1)" class="leitner-btn box-1">1</button>
                <button @click="rateItemFullscreen(2)" class="leitner-btn box-2">2</button>
                <button @click="rateItemFullscreen(3)" class="leitner-btn box-3">3</button>
                <button @click="rateItemFullscreen(4)" class="leitner-btn box-4">4</button>
            </div>
        </div>

        <button @click="exitFullscreen()" class="btn btn-error">
            <i class="fas fa-times mr-2"></i>Salir
        </button>
    </div>
</div>

<script>
function studySession(sessionId) {
    return {
        currentIndex: 0,
        totalItems: {{ user_reviews|length }},
        isFullscreen: false,
        sessionId: sessionId,
        
        selectItem(index) {
            this.currentIndex = index;
        },
        
        previousItem() {
            if (this.currentIndex > 0) {
                this.currentIndex--;
            }
        },
        
        nextItem() {
            if (this.currentIndex < this.totalItems - 1) {
                this.currentIndex++;
            }
        },
        
        enterFullscreen() {
            this.isFullscreen = true;
            document.body.style.overflow = 'hidden';
            // Re-initialize components for fullscreen
            setTimeout(() => {
                initializeABCJS();
                initializeChordPro();
            }, 100);
        },
        
        exitFullscreen() {
            this.isFullscreen = false;
            document.body.style.overflow = 'auto';
        },
        
        rateItem(rating) {
            this.submitRating(rating);
        },
        
        rateItemFullscreen(rating) {
            this.submitRating(rating);
            // Auto advance to next item
            setTimeout(() => {
                if (this.currentIndex < this.totalItems - 1) {
                    this.nextItem();
                } else {
                    this.finishSession();
                }
            }, 500);
        },
        
        submitRating(rating) {
            const reviewIds = [{% for review in user_reviews %}{{ review.id }}{% if not forloop.last %},{% endif %}{% endfor %}];
            const currentReviewId = reviewIds[this.currentIndex];
            
            fetch('{% url "music_cards:rate_item" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    review_id: currentReviewId,
                    rating: rating
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    console.log('Rating submitted successfully');
                } else {
                    console.error('Error submitting rating:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        },
        
        finishSession() {
            if (confirm('¿Estás seguro de que quieres terminar la sesión de estudio?')) {
                window.location.href = '{% url "music_cards:finish_study_session" study_session.id %}';
            }
        }
    }
}
</script>
{% endblock content %}
