{% extends "base.html" %}
{% load wagtailcore_tags %}

{# MUSIC PILLS - Plantilla de p√°gina de partitura #}
{# Esta plantilla puede ser extra√≠da para usar en otra instalaci√≥n de Wagtail #}

{% block title %}{{ page.title }} - Music Pills{% endblock %}

{% block extra_css %}
<!-- PDF.js CSS -->
<style>
    .pdf-viewer {
        width: 100%;
        height: 80vh;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    .streamfield-content {
        max-width: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row justify-between items-start gap-6 mb-8">
        <div class="flex-1">
            <h1 class="text-4xl font-bold mb-2">{{ page.title }}</h1>
            {% if page.composer %}
            <p class="text-xl text-base-content/70 mb-4">by {{ page.composer.name }}</p>
            {% endif %}
            
            <!-- Metadata badges -->
            <div class="flex flex-wrap gap-2 mb-4">
                {% if page.difficulty_level %}
                <div class="badge badge-primary">{{ page.get_difficulty_level_display }}</div>
                {% endif %}
                {% if page.rating %}
                <div class="badge badge-secondary">
                    {% for i in "12345" %}
                        {% if forloop.counter <= page.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                {% for category in page.categories.all %}
                <div class="badge badge-outline">{{ category.name }}</div>
                {% endfor %}
                {% for tag in page.tags.all %}
                <div class="badge badge-accent badge-outline">{{ tag.name }}</div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Actions -->
        <div class="flex gap-2">
            <a href="/cms/pages/{{ page.id }}/edit/" class="btn btn-primary">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit
            </a>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                    </svg>
                </div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a href="/cms/pages/{{ page.id }}/copy/">Duplicate</a></li>
                    <li><a>Add to Setlist</a></li>
                    <li><a>Download PDF</a></li>
                    <li><a>Share</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- StreamField Content -->
    <div class="streamfield-content">
        {% for block in page.content %}
            {% if block.block_type == 'pdf_score' %}
            <!-- PDF Score Block -->
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">üìÑ {{ block.value.title }}</h2>
                    {% if block.value.description %}
                    <p class="text-base-content/70">{{ block.value.description }}</p>
                    {% endif %}
                    
                    {% if block.value.pdf_file %}
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium">PDF Viewer</span>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-outline" onclick="zoomOut()">-</button>
                                <button class="btn btn-sm btn-outline" onclick="zoomIn()">+</button>
                                <a href="{{ block.value.pdf_file.url }}" target="_blank" class="btn btn-sm btn-primary">
                                    Open Full PDF
                                </a>
                            </div>
                        </div>
                        <iframe 
                            src="{{ block.value.pdf_file.url }}" 
                            class="pdf-viewer"
                            type="application/pdf">
                            <p>Your browser doesn't support PDF viewing. 
                               <a href="{{ block.value.pdf_file.url }}" class="link">Download the PDF</a> instead.
                            </p>
                        </iframe>
                        {% if block.value.page_count %}
                        <p class="text-xs text-base-content/50 mt-2">{{ block.value.page_count }} pages</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% elif block.block_type == 'metadata' %}
            <!-- Metadata Block -->
            <div class="card bg-base-200 shadow-lg mb-6">
                <div class="card-body">
                    <h2 class="card-title">üè∑Ô∏è Musical Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% if block.value.composer %}
                        <div>
                            <span class="font-medium">Composer:</span>
                            <span>{{ block.value.composer }}</span>
                        </div>
                        {% endif %}
                        {% if block.value.key_signature %}
                        <div>
                            <span class="font-medium">Key:</span>
                            <span>{{ block.value.key_signature }}</span>
                        </div>
                        {% endif %}
                        {% if block.value.tempo %}
                        <div>
                            <span class="font-medium">Tempo:</span>
                            <span>{{ block.value.tempo }}</span>
                        </div>
                        {% endif %}
                        {% if block.value.difficulty %}
                        <div>
                            <span class="font-medium">Difficulty:</span>
                            <span>{{ block.value.difficulty }}</span>
                        </div>
                        {% endif %}
                        {% if block.value.duration_minutes %}
                        <div>
                            <span class="font-medium">Duration:</span>
                            <span>{{ block.value.duration_minutes }} min</span>
                        </div>
                        {% endif %}
                        {% if block.value.rating %}
                        <div>
                            <span class="font-medium">Rating:</span>
                            <span>{{ block.value.rating }}/5 ‚≠ê</span>
                        </div>
                        {% endif %}
                        {% if block.value.reference %}
                        <div class="md:col-span-2 lg:col-span-3">
                            <span class="font-medium">Reference:</span>
                            <span>{{ block.value.reference }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% elif block.block_type == 'bookmarks' %}
            <!-- Bookmarks Block -->
            <div class="card bg-base-100 shadow-lg mb-6">
                <div class="card-body">
                    <h2 class="card-title">üîñ Bookmarks</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Page(s)</th>
                                    <th>Type</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bookmark in block.value %}
                                <tr>
                                    <td class="font-medium">{{ bookmark.title }}</td>
                                    <td>{{ bookmark.page_number }}</td>
                                    <td>
                                        <div class="badge badge-sm">{{ bookmark.bookmark_type }}</div>
                                    </td>
                                    <td class="text-sm text-base-content/70">{{ bookmark.notes|default:"‚Äî" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            {% elif block.block_type == 'notes' %}
            <!-- Notes Block -->
            <div class="card bg-base-100 shadow-lg mb-6">
                <div class="card-body">
                    <h2 class="card-title">üìù Notes</h2>
                    <div class="prose max-w-none">
                        {{ block.value|richtext }}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Navigation -->
    <div class="flex justify-between items-center mt-8">
        <a href="{{ page.get_parent.get_url }}" class="btn btn-ghost">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Library
        </a>
        
        <div class="text-sm text-base-content/50">
            Last updated: {{ page.last_published_at|date:"M d, Y" }}
        </div>
    </div>
</div>

<script>
function zoomIn() {
    // Basic zoom functionality - can be enhanced with PDF.js
    const iframe = document.querySelector('.pdf-viewer');
    const currentWidth = iframe.style.width || '100%';
    // Simple zoom implementation
}

function zoomOut() {
    // Basic zoom functionality - can be enhanced with PDF.js
    const iframe = document.querySelector('.pdf-viewer');
    // Simple zoom implementation
}
</script>
{% endblock %}
