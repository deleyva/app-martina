{% extends "base.html" %}

{% block title %}Biblioteca de {{ group.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Mejoras visuales para filas de lista */
    .list-row:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* Responsive para m贸viles */
    @media (max-width: 768px) {
        .list-row {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.75rem;
        }
        
        .list-row > div:last-child {
            width: 100%;
        }
        
        .list-row .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold"> Biblioteca de {{ group.name }}</h1>
            <p class="text-sm text-base-content/70 mt-1">Biblioteca compartida del grupo</p>
        </div>
        <a href="/pages/indice-de-recursos-musicales/" class="btn btn-ghost btn-sm sm:btn-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Volver a ndice de Recursos Musicales
        </a>
    </div>
    
    <div class="stats shadow mb-6">
        <div class="stat">
            <div class="stat-figure text-primary">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div class="stat-title">Elementos en la biblioteca</div>
            <div class="stat-value text-primary">{{ total_items }}</div>
            <div class="stat-desc">Disponibles para el grupo</div>
        </div>
    </div>
    
    {% if items %}
    {% include "partials/library_filter_controls.html" %}

    <!-- Lista (una fila por elemento) -->
    <ul class="list bg-base-100 rounded-box shadow-md" id="groupLibraryItemsList">
        <li class="p-4 pb-2 text-xs opacity-60 tracking-wide">
            Biblioteca del grupo 路 Ordenado por fecha de adici贸n (m谩s recientes primero)
        </li>
        
        {% for item in items %}
        {% with related_score=item.get_related_scorepage %}
        <li class="list-row group-library-item js-library-filter-item" id="library-item-{{ item.pk }}"
            data-title="{{ item.get_content_title|lower }}"
            data-type="{{ item.get_content_type_name|lower }}"
            data-related-score="{% if related_score %}{{ related_score.title|lower }}{% endif %}"
            data-composer="{% if related_score and related_score.composer %}{{ related_score.composer.name|lower }}{% endif %}"
            data-categories="{% if related_score and related_score.categories.all %}{% for category in related_score.categories.all %}{{ category.name|lower }} {% endfor %}{% endif %}"
            data-tags="{% if item.content_object and item.content_object.tags.all %}{% for tag in item.content_object.tags.all %}{{ tag.name|lower }} {% endfor %}{% endif %}{% if related_score and related_score.tags.all %}{% for tag in related_score.tags.all %}{{ tag.name|lower }} {% endfor %}{% endif %}"
            data-pdfs="{% if related_score %}{% for pdf in related_score.get_pdf_blocks %}{{ pdf.title|lower }} {% endfor %}{% endif %}"
            data-audios="{% if related_score %}{% for audio in related_score.get_audios %}{{ audio.title|lower }} {% endfor %}{% endif %}"
            data-document-tags="{% if related_score %}{% for pdf in related_score.get_pdf_blocks %}{% for doc_tag in pdf.pdf_file.tags.all %}{{ doc_tag.name|lower }} {% endfor %}{% endfor %}{% for audio in related_score.get_audios %}{% for doc_tag in audio.audio_file.tags.all %}{{ doc_tag.name|lower }} {% endfor %}{% endfor %}{% endif %}">
            <!-- Icon -->
            <div class="flex items-center justify-center size-12 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-lg flex-shrink-0">
                <div class="text-2xl">{{ item.get_icon }}</div>
            </div>
            
            <!-- Info -->
            <div class="flex-1 min-w-0">
                <div class="font-semibold text-base">{{ item.get_content_title }}</div>
                <div class="text-xs opacity-60">{{ item.get_content_type_name }}</div>
                
                <!-- Enlace a ScorePage relacionada (SIEMPRE visible) -->
                {% if related_score %}
                <div class="mt-1">
                    <a href="{{ related_score.get_url }}" 
                       class="inline-flex items-center gap-1 text-xs {% if item.content_type.model == 'scorepage' %}link link-success{% else %}link link-primary{% endif %} link-hover">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        {% if item.content_type.model == 'scorepage' %}
                        Ver en Biblioteca
                        {% else %}
                        De: {{ related_score.title }}
                        {% endif %}
                    </a>
                </div>
                {% endif %}
                
                <!-- Meta info -->
                <div class="text-xs opacity-40 mt-1 flex items-center gap-3">
                    <span>A帽adido: {{ item.added_at|date:"d/m/Y" }}</span>
                    {% if item.added_by %}
                    <span>路 Por: {% if item.added_by.name %}{{ item.added_by.name }}{% elif item.added_by.first_name and item.added_by.last_name %}{{ item.added_by.first_name }} {{ item.added_by.last_name }}{% else %}{{ item.added_by.email }}{% endif %}</span>
                    {% endif %}
                    {% if item.content_type.model == 'scorepage' %}
                        {# Para ScorePages: mostrar contador sumatorio de todos sus elementos #}
                        {% with session_count=item.get_scorepage_total_session_count %}
                        {% if session_count > 0 %}
                        <span>路 Usado en {{ session_count }} sesi贸n{% if session_count != 1 %}es{% endif %} de clase</span>
                        {% endif %}
                        {% endwith %}
                    {% else %}
                        {# Para otros elementos: mostrar contador individual #}
                        {% with session_count=item.get_session_count %}
                        {% if session_count > 0 %}
                        <span>路 Usado en {{ session_count }} sesi贸n{% if session_count != 1 %}es{% endif %} de clase</span>
                        {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>

                <!-- Nivel del grupo -->
                <div class="mt-2">
                    {% include "clases/group_library/partials/group_proficiency_stars.html" with item=item group=group %}
                </div>

                <!-- Notas del profesor -->
                {% if item.notes %}
                <div class="mt-2 text-sm text-base-content/70 p-2 bg-base-200 rounded">
                     {{ item.notes }}
                </div>
                {% endif %}
            </div>
            
            <!-- Actions -->
            <div class="flex gap-2 items-center">
                {% if item.content_type.model == 'scorepage' %}
                <a href="{{ item.content_object.get_url }}" class="btn btn-sm btn-primary">
                    Ver Partitura
                </a>
                {% else %}
                <a href="{{ item.get_viewer_url }}" class="btn btn-sm btn-primary">
                    Abrir visor
                </a>
                {% endif %}

                <button hx-delete="{% url 'clases:group_library_remove' group.id item.pk %}"
                        hx-target="#library-item-{{ item.pk }}"
                        hx-swap="outerHTML"
                        hx-confirm="驴Quitar de la biblioteca del grupo?"
                        class="btn btn-sm btn-ghost btn-square"
                        title="Quitar de biblioteca">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </li>
        {% endwith %}
        {% endfor %}
    </ul>

    {% include "partials/library_filter_script.html" %}
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-12 bg-base-100 rounded-box shadow">
        <div class="text-6xl mb-4"></div>
        <h2 class="text-2xl font-bold mb-2">La biblioteca del grupo est谩 vac铆a</h2>
        <p class="text-base-content/70 mb-6">
            Explora la biblioteca musical y a帽ade contenido para compartir con el grupo {{ group.name }}.
        </p>
        <a href="/pages/indice-de-recursos-musicales/" class="btn btn-primary">
            Explorar Biblioteca Musical
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
